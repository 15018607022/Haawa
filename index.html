<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Haawa au - ÿ∫ÿ±ŸÅ ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Variables & Global Reset --- */
        :root {
            --primary: #000E0F;
            --secondary: #001F23;
            --accent: #00333A;
            --light: #004047;
            --header-light: #001A1F;
            --text: #F5F5F5;
            --text-muted: #b0b0b0;
            --border-color: rgba(255, 255, 255, 0.1);
            --bubble-red: #4d0f0f;
            --bubble-red-border: #8b1a1a;
            --bubble-blue: #0f2b4d;
            --bubble-blue-border: #1a4f8b;
            --bubble-green: #104d0f;
            --bubble-green-border: #1e8b1a;
            --bubble-gold: #614a0a;
            --bubble-gold-border: #b48613;
            --bubble-orange: #61350a;
            --bubble-orange-border: #b46013;
            --bubble-default: var(--accent);
            --bubble-default-border: var(--light);
            --sidebar-width: 280px;
            --transition-speed-fast: 0.2s;
            --transition-speed-medium: 0.3s;
            --transition-speed-slow: 0.45s;
            --transition-timing: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--primary);
            color: var(--text);
            direction: rtl;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            position: relative;
        }

        /* --- Navbar --- */
        .navbar {
            background: var(--header-light);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color var(--transition-speed-medium) ease;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
        }

        .navbar img {
            width: 60px;
            height: 40px;
            border-radius: 10px;
            margin-left: 10px;
            object-fit: cover;
            border: 2px solid var(--light);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform var(--transition-speed-medium) ease;
        }

        .navbar img:hover {
            transform: scale(1.05);
        }

        .navbar .caption {
            font-size: 16px;
            color: var(--text);
            font-weight: 500;
        }

        /* --- Sidebar Icon --- */
        .sidebar-icon-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .sidebar-toggle-icon {
            color: var(--text);
            font-size: 24px;
            transition: color var(--transition-speed-medium) ease, transform var(--transition-speed-medium) ease;
        }

        .sidebar-toggle-icon:hover {
            color: var(--light);
            transform: rotate(90deg);
        }

        /* --- Sidebar & Overlay --- */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2400;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed-slow) ease, visibility 0s linear var(--transition-speed-slow);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity var(--transition-speed-slow) ease;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: calc(-1 * var(--sidebar-width)); /* Start off-screen right for RTL */
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--secondary);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            z-index: 2500;
            padding: 25px 15px;
            transition: right var(--transition-speed-slow) var(--transition-timing);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--accent);
        }

        .sidebar.active {
            right: 0; /* Slide in */
        }

        /* --- Sidebar Profile Area --- */
        .sidebar-profile-area {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 15px; /* Reduced top padding after removing icon */
            position: relative;
        }

        /* REMOVED: .edit-profile-icon {} */
        /* REMOVED: .edit-profile-icon:hover {} */

        .profile-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: var(--accent);
            margin: 0 auto 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            color: var(--text);
            border: 3px solid var(--light);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .sidebar-profile-area .official-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 5px;
        }

        .sidebar-profile-area .id-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 25px;
        }

        .sidebar-profile-area .id-copy-icon {
            cursor: pointer;
            font-size: 16px;
            color: var(--light);
            transition: color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
        }

        .sidebar-profile-area .id-copy-icon:hover {
            color: var(--text);
            transform: scale(1.2);
        }

        .sidebar-profile-area .id-copy-icon.copied {
            color: #4caf50; /* Green checkmark indication */
        }

        /* --- Sidebar Navigation --- */
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar-nav li {
            display: flex;
            align-items: center;
            padding: 14px 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color var(--transition-speed-medium) ease,
                        transform var(--transition-speed-fast) ease,
                        box-shadow var(--transition-speed-medium) ease;
            color: var(--text);
            font-size: 15px;
            overflow: hidden; /* Helps contain effects */
        }

        .sidebar-nav li i {
            margin-left: 18px;
            width: 22px;
            text-align: center;
            color: var(--light);
            font-size: 18px;
            transition: color var(--transition-speed-medium) ease,
                        transform var(--transition-speed-medium) ease; /* Added transform transition */
        }

        .sidebar-nav li span {
            transition: transform var(--transition-speed-medium) ease; /* Transition for text movement */
        }

        /* Enhanced Interaction Effect */
        .sidebar-nav li:hover {
            background-color: var(--accent);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transform: translateX(-6px) scale(1.01); /* Slightly more pronounced effect */
        }

        .sidebar-nav li:hover i {
            color: var(--text);
            transform: scale(1.1) rotate(-5deg); /* Icon scales and tilts slightly */
        }
        .sidebar-nav li:hover span {
            transform: translateX(3px); /* Text moves slightly right */
        }


        .sidebar-nav li:active {
            transform: translateX(-2px) scale(0.98); /* Refined click feedback */
            background-color: var(--light);
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.25); /* Slightly deeper inner shadow */
        }

        /* --- Banners --- */
        .banner-container {
            max-width: 1024px;
            margin: 20px auto;
            padding: 0 15px;
            overflow: hidden;
        }

        .banners {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 2400 / 660;
            max-height: 400px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .banners-wrapper {
            display: flex;
            transition: transform 0.5s ease;
            height: 100%;
        }

        .banner-slide {
            min-width: 100%;
            height: 100%;
            flex-shrink: 0;
        }

        .banners img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .banner-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 5;
        }

        .banner-dot {
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease; /* Added transform */
        }
        .banner-dot:hover {
            transform: scale(1.2);
        }

        .banner-dot.active {
            background: #fff;
             transform: scale(1.3); /* Active dot is larger */
        }

        .banner-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            z-index: 10;
            transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
        }

        .banner-nav:hover {
            background: rgba(0, 0, 0, 0.6);
            transform: translateY(-50%) scale(1.1); /* Scale on hover */
        }
         .banner-nav:active {
            transform: translateY(-50%) scale(1.0); /* Scale back on click */
         }

        .banner-prev { left: 15px; }
        .banner-next { right: 15px; }

        /* --- Chat Rooms Section --- */
        .rooms-section {
            padding: 30px 15px;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .room-box {
            background: var(--secondary);
            border-radius: 15px;
            overflow: hidden;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
            transition: all var(--transition-speed-medium) var(--transition-timing);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            aspect-ratio: 1 / 1;
        }

        .room-box:hover {
            transform: translateY(-8px) scale(1.03); /* Enhanced hover effect */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            border-color: var(--light);
        }

        .room-box .room-image-container {
            flex-grow: 1;
            overflow: hidden;
            width: 100%;
            background-color: var(--accent);
        }

        .room-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform var(--transition-speed-slow) ease; /* Slower image zoom */
        }

        .room-box:hover img {
            transform: scale(1.1); /* More pronounced zoom */
        }

        .room-box h3 {
            font-size: 15px;
            padding: 12px 10px;
            color: var(--text);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: var(--secondary);
            margin: 0;
            transition: color var(--transition-speed-medium) ease;
        }
        .room-box:hover h3 {
            color: #a2d2db; /* Change text color on hover */
        }

        /* --- Modal (Entry Form) --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
            animation: fadeIn var(--transition-speed-medium) ease-out;
        }

        .modal-content {
            background: var(--secondary);
            margin: 8% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 450px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: slideIn var(--transition-speed-slow) ease-out;
        }

        .modal .close {
            position: absolute;
            top: 10px;
            left: 15px;
            font-size: 30px;
            color: #aaa;
            cursor: pointer;
            transition: color var(--transition-speed-medium), transform var(--transition-speed-medium) ease;
            line-height: 1;
        }

        .modal .close:hover {
            color: #fff;
            transform: rotate(180deg); /* Spin effect */
        }

        .modal h2 {
            margin-bottom: 25px;
            color: var(--text);
            font-size: 20px;
            text-align: center;
        }

        .modal label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
            font-size: 14px;
        }

        .modal input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--accent);
            background: var(--primary);
            border-radius: 8px;
            color: var(--text);
            font-size: 15px;
            margin-bottom: 15px;
            font-family: 'Tajawal', sans-serif;
            transition: border-color var(--transition-speed-medium) ease, box-shadow var(--transition-speed-medium) ease;
        }

        .modal input[type="text"]:focus {
            outline: none;
            border-color: var(--light);
            box-shadow: 0 0 0 3px rgba(0, 64, 71, 0.5);
        }

        .modal .options-container {
            margin-bottom: 20px;
        }

        .modal .avatar-options, .modal .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 5px;
        }

        .modal input[type="radio"] {
            display: none;
        }

        .modal .avatar-label, .modal .color-label {
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all var(--transition-speed-fast) ease;
            display: flex; /* Center content */
            align-items: center; /* Center content */
            justify-content: center; /* Center content */
        }

        .modal .avatar-label {
            font-size: 24px;
            background-color: var(--accent);
            line-height: 1;
            padding: 5px 8px;
             width: 40px; /* Ensure consistent size */
             height: 40px;
        }

        .modal .color-label {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        .modal input[type="radio"]:checked + label {
            border-color: #a2d2db;
            transform: scale(1.15) rotate(5deg); /* Tilt effect when selected */
            box-shadow: 0 0 12px rgba(162, 210, 219, 0.8);
        }
        .modal input[type="radio"]:not(:checked) + label:hover {
            transform: scale(1.05); /* Slight scale on hover for unselected */
            border-color: rgba(162, 210, 219, 0.5); /* Subtle hover border */
        }


        /* Specific color styles */
        .modal .color-label[for="color-red"] { background-color: var(--bubble-red); }
        .modal .color-label[for="color-blue"] { background-color: var(--bubble-blue); }
        .modal .color-label[for="color-green"] { background-color: var(--bubble-green); }
        .modal .color-label[for="color-gold"] { background-color: var(--bubble-gold); }
        .modal .color-label[for="color-orange"] { background-color: var(--bubble-orange); }
        .modal .color-label[for="color-default"] { background-color: var(--bubble-default); }

        .modal .entry-button {
            background: linear-gradient(135deg, var(--light), var(--accent));
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            display: block;
            text-align: center;
            width: 100%;
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed-slow) var(--transition-timing);
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal .entry-button:hover {
            background: linear-gradient(135deg, var(--accent), var(--light));
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
        }
         .modal .entry-button:active {
            transform: translateY(-1px) scale(0.99);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
         }

        /* --- Chat Page --- */
        .chat-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary);
            z-index: 1500;
            display: none;
            flex-direction: column;
            animation: slideInFromBottom var(--transition-speed-slow) ease-out;
        }

        .chat-header {
            background: var(--header-light);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .chat-header .back-button {
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: color var(--transition-speed-medium) ease, transform var(--transition-speed-medium) ease;
        }

        .chat-header .back-button:hover {
            color: var(--light);
            transform: scale(1.1) translateX(3px); /* Move slightly on hover */
        }
        .chat-header .back-button:active {
            transform: scale(1.0);
        }

        .chat-header .title {
            font-size: 17px;
            font-weight: 500;
            color: var(--text);
            text-align: center;
            flex-grow: 1;
            margin: 0 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header .header-spacer {
            width: 34px; /* Match back button width approx */
        }

        .chat-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        /* --- Welcome Message --- */
        .welcome-message-container {
            display: flex;
            align-items: center;
            background-color: rgba(0, 31, 35, 0.5);
            padding: 12px 15px;
            border-radius: 10px;
            margin: 0 auto 15px auto;
            max-width: 90%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s 0.2s ease-out backwards;
            border-left: 3px solid var(--light);
        }

        .welcome-message-container .fa-lock {
            color: #a2d2db;
            font-size: 16px;
            margin-left: 10px;
        }

        .welcome-message-container p {
            color: #d5d5d5;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }

        /* --- Messages General --- */
        .message-item {
            max-width: 80%;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            position: relative;
            transition: transform var(--transition-speed-fast) ease-out; /* Faster swipe feedback */
            user-select: none;
            animation: popIn var(--transition-speed-medium) ease-out;
        }

        .message-item.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-item.received {
            align-self: flex-start;
        }

        .message-item.swiping {
            transition: none; /* Disable smooth transition during active swipe */
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px;
            background-color: var(--secondary);
            color: var(--text);
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 5px; /* Align better with first line of text */
            border: 1px solid var(--accent);
        }

        .message-item.sent .message-avatar {
            background-color: var(--accent);
            border-color: var(--light);
        }

        /* --- Message Bubble --- */
        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15); /* Slightly enhanced shadow */
            position: relative;
            word-wrap: break-word;
            max-width: calc(100% - 48px); /* Ensure it doesn't overlap avatar */
            border: 1px solid transparent;
            transition: background-color var(--transition-speed-medium) ease;
        }

        /* Bubble Colors & Shapes */
        .message-item.sent .message-bubble { border-bottom-right-radius: 4px; }
        .message-item.received .message-bubble { background: var(--secondary); border-bottom-left-radius: 4px; border: 1px solid var(--accent); }

        .message-item.sent .bubble-red { background-color: var(--bubble-red); border-color: var(--bubble-red-border); }
        .message-item.sent .bubble-blue { background-color: var(--bubble-blue); border-color: var(--bubble-blue-border); }
        .message-item.sent .bubble-green { background-color: var(--bubble-green); border-color: var(--bubble-green-border); }
        .message-item.sent .bubble-gold { background-color: var(--bubble-gold); border-color: var(--bubble-gold-border); }
        .message-item.sent .bubble-orange { background-color: var(--bubble-orange); border-color: var(--bubble-orange-border); }
        .message-item.sent .bubble-default { background-color: var(--bubble-default); border-color: var(--bubble-default-border); }

        /* --- Message Content --- */
        .message-sender {
            font-weight: bold;
            margin-bottom: 4px;
            color: #a2d2db;
            font-size: 13px;
        }

        .message-text {
            color: #e0e0e0;
            font-size: 15px;
            line-height: 1.45;
        }

        .message-time {
            font-size: 11px;
            color: #a0a0a0;
            margin-top: 5px;
            text-align: left;
        }

        .message-item.sent .message-time {
            text-align: right;
        }

        /* --- Reply Context Display (within bubble) --- */
         .reply-context-display {
            background-color: rgba(0, 0, 0, 0.25); /* Slightly darker */
            padding: 6px 10px;
            margin: -2px 0 8px 0; /* Pull up slightly, more bottom margin */
            border-radius: 8px;
            border-left: 3px solid var(--light);
            font-size: 13px;
            color: #c0c0c0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            cursor: pointer; /* Indicate it might be clickable (future feature?) */
            transition: background-color var(--transition-speed-fast) ease;
        }
        .reply-context-display:hover {
            background-color: rgba(0, 0, 0, 0.4); /* Darken on hover */
        }
        .reply-context-display strong {
            color: #a2d2db;
            font-weight: 600; /* Slightly bolder */
        }

        /* --- Chat Input Area --- */
        .chat-input-area {
            padding: 12px 15px;
            background: var(--header-light);
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            transition: padding-bottom var(--transition-speed-fast) ease;
        }

        /* --- Reply Preview (above input) --- */
        #replyPreview {
            display: none; /* Hidden by default */
            background-color: rgba(0, 64, 71, 0.3);
            padding: 8px 12px 10px 35px; /* Make space for cancel button */
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 13px;
            color: #e0e0e0;
            position: relative;
            animation: slideInFromTop var(--transition-speed-medium) ease-out;
            overflow: hidden;
        }

        #replyPreview .reply-preview-content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
            line-height: 1.3;
        }

         #replyPreview .reply-preview-sender {
            font-weight: bold;
            color: #a2d2db;
        }

        #replyPreview .cancel-reply {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 10px; /* Positioned left for RTL */
            font-size: 22px; /* Larger cancel icon */
            color: #aaa;
            cursor: pointer;
            line-height: 1;
            transition: color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
        }

         #replyPreview .cancel-reply:hover {
            color: #fff;
            transform: translateY(-50%) scale(1.2);
         }

        /* --- Input Controls (Textarea + Send) --- */
        .chat-input-controls {
            display: flex;
            align-items: flex-end; /* Align items to bottom */
        }

        .chat-input {
            flex: 1;
            background: var(--secondary);
            border: 1px solid var(--accent); /* Subtle border */
            border-radius: 20px;
            padding: 10px 18px;
            color: var(--text);
            font-family: 'Tajawal', sans-serif;
            font-size: 15px;
            resize: none;
            max-height: 100px; /* Limit expansion */
            min-height: 20px; /* Start small */
            line-height: 1.4;
            overflow-y: auto;
            transition: box-shadow var(--transition-speed-medium) ease, border-color var(--transition-speed-medium) ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--light);
            box-shadow: 0 0 0 2px rgba(0, 64, 71, 0.4);
        }

        .send-button {
            background: var(--accent);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px; /* Space between input and button */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
            flex-shrink: 0;
            position: relative; /* For wave effect */
            overflow: hidden; /* Contain wave */
        }

        .send-button:hover {
            background: var(--light);
            transform: scale(1.1) rotate(-10deg); /* Rotate slightly on hover */
        }

        .send-button:active {
            transform: scale(0.95);
            transition-duration: 0.1s; /* Faster feedback on click */
        }

        .send-button i {
            font-size: 18px;
            position: relative;
            z-index: 2;
            transition: transform var(--transition-speed-fast) ease;
        }
        .send-button:active i {
             transform: scale(0.9); /* Icon shrinks slightly on click */
        }

        /* Sound Wave Effect */
        .send-button::before,
        .send-button::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 100%; height: 100%;
            border: 2px solid rgba(0, 150, 255, 0.4); /* More subtle blue */
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(1);
            opacity: 0;
            animation: wave 1.8s infinite ease-out; /* Slightly faster wave */
            z-index: 1;
            pointer-events: none;
        }
        .send-button::after { animation-delay: 0.4s; }
        @keyframes wave {
            0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(2.2); opacity: 0; }
        }

        /* --- Loading & Confirmation --- */
        .loading-placeholder {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 16px;
            font-style: italic;
        }

        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75); /* Slightly darker overlay */
            z-index: 3000;
            justify-content: center;
            align-items: center;
            animation: fadeIn var(--transition-speed-fast) ease;
        }

        .confirmation-box {
            background: var(--secondary);
            padding: 25px 30px; /* More horizontal padding */
            border-radius: 12px; /* Slightly larger radius */
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            text-align: center;
            max-width: 320px; /* Slightly wider */
            animation: slideIn var(--transition-speed-medium) ease-out;
            border-top: 3px solid var(--light); /* Top border accent */
        }

        .confirmation-box p {
            margin-bottom: 25px; /* More space before buttons */
            color: var(--text);
            font-size: 16px;
            line-height: 1.5;
        }

        .confirmation-buttons button {
            padding: 10px 25px; /* Wider buttons */
            margin: 0 8px;
            border: none;
            border-radius: 8px; /* Rounded buttons */
            font-size: 15px;
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease, box-shadow var(--transition-speed-fast) ease;
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
        }

        #confirmDeleteBtn {
            background-color: #c0392b; /* Standard red */
            color: white;
            box-shadow: 0 2px 4px rgba(192, 57, 43, 0.3);
        }
        #confirmDeleteBtn:hover {
            background-color: #e74c3c; /* Lighter red */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(192, 57, 43, 0.4);
        }
         #confirmDeleteBtn:active {
             transform: translateY(0px);
             box-shadow: 0 1px 2px rgba(192, 57, 43, 0.3);
         }

        #cancelDeleteBtn {
            background-color: var(--accent);
            color: white;
             box-shadow: 0 2px 4px rgba(0, 51, 58, 0.3);
        }
        #cancelDeleteBtn:hover {
            background-color: var(--light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 51, 58, 0.4);
        }
         #cancelDeleteBtn:active {
             transform: translateY(0px);
             box-shadow: 0 1px 2px rgba(0, 51, 58, 0.3);
         }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(25px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes slideOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(25px) scale(0.98); } }
        @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(60px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOutToBottom { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(60px); } }
        @keyframes slideInFromTop { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn {
            0% { transform: scale(0.85); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }


        /* --- Media Queries (Responsive Design) --- */
        @media (max-width: 768px) {
            :root { --sidebar-width: 250px; }
            .rooms-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; }
            .modal-content { margin: 15% auto; padding: 25px; max-width: 90%; }
            .banners { aspect-ratio: 16/7; max-height: 300px; }
            .message-item { max-width: 90%; }
            .welcome-message-container { max-width: 95%; }
        }

        @media (max-width: 480px) {
            :root { --sidebar-width: 220px; }
            .navbar { padding: 0.8rem; }
            .navbar img { width: 50px; height: 35px; }
            .navbar .caption { font-size: 15px; }
            .sidebar-toggle-icon { font-size: 22px; }

            .profile-circle { width: 70px; height: 70px; font-size: 30px; margin-bottom: 10px;}
             .sidebar-profile-area .official-text { font-size: 15px; }
             .sidebar-profile-area .id-section { font-size: 13px; margin-bottom: 20px; }
             .sidebar-profile-area .id-copy-icon { font-size: 15px; }

            .sidebar-nav li { padding: 12px 10px; font-size: 14px; margin-bottom: 6px; }
            .sidebar-nav li i { margin-left: 15px; font-size: 17px; width: 20px; }
            .sidebar-nav li:hover { transform: translateX(-4px) scale(1.0); } /* Less movement on mobile */

            .banner-nav { width: 30px; height: 30px; font-size: 14px; }
            .banner-dot { width: 10px; height: 10px; }
            .banner-dot.active { transform: scale(1.2); }

            .rooms-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
            .room-box h3 { font-size: 14px; padding: 10px 8px; }

            .modal-content { margin: 20% auto; padding: 20px; }
            .modal h2 { font-size: 18px; }
            .modal .avatar-label { font-size: 22px; width: 35px; height: 35px; }
            .modal .color-label { width: 30px; height: 30px; }
            .modal .entry-button { font-size: 15px; padding: 12px; }

            .chat-header { padding: 0.7rem 0.8rem; }
            .chat-header .title { font-size: 16px; }
            .chat-header .back-button { font-size: 22px; }
            .chat-header .header-spacer { width: 30px; }

            .message-text { font-size: 14px; }
            .message-sender { font-size: 12px; }
            .message-time { font-size: 10px; }
            .message-avatar { width: 28px; height: 28px; font-size: 16px; margin-top: 3px;}
            .message-bubble { padding: 8px 12px; border-radius: 16px; }
            .message-item { max-width: 92%; margin-bottom: 12px; }
             .reply-context-display { font-size: 12px; padding: 5px 8px; }

            .welcome-message-container p { font-size: 13px; }
            .welcome-message-container .fa-lock { font-size: 14px; }

            .chat-input-area { padding: 10px 12px; }
            .chat-input { padding: 9px 15px; font-size: 14px; min-height: 18px; }
            .send-button { width: 36px; height: 36px; margin-right: 8px; }
            .send-button i { font-size: 16px; }
             /* Disable wave animation on small screens if performance is an issue */
             /* .send-button::before, .send-button::after { animation: none; display: none; } */

            #replyPreview { padding: 6px 10px 8px 30px; font-size: 12px; }
            #replyPreview .cancel-reply { font-size: 20px; left: 8px;}

             .confirmation-box { max-width: 90%; padding: 20px 25px; }
             .confirmation-box p { font-size: 15px; }
             .confirmation-buttons button { padding: 9px 20px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">
            <img id="navbarLogo" src="https://i.postimg.cc/QCtCTctL/IMG.jpg" alt="ÿßŸÑÿ¥ÿπÿßÿ±">
            <div class="caption">Haawa au</div>
        </div>
        <div class="sidebar-icon-wrapper" id="sidebarToggleBtn">
            <div class="sidebar-toggle-icon">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="sidebar" id="sidebarMenu">
        <div class="sidebar-profile-area">
            <div class="profile-circle">
                üë§ </div>
            <p class="official-text">Official</p> <div class="id-section">
                <span id="userID">ID 12345789</span> <i class="fas fa-copy id-copy-icon" id="idCopyIcon" title="ŸÜÿ≥ÿÆ ÿßŸÑŸÄ ID"></i>
            </div>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li><i class="fas fa-home"></i><span>ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span></li>
                <li><i class="fas fa-wallet"></i><span>ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©</span></li>
                <li><i class="fas fa-store"></i><span>ÿßŸÑŸÖÿ™ÿ¨ÿ±</span></li>
                <li><i class="fas fa-shopping-bag"></i><span>ÿ≠ŸÇŸäÿ®ÿ™Ÿä</span></li>
                <li><i class="fas fa-user-edit"></i><span>ÿ™ÿ≠ÿ±Ÿäÿ±</span></li>
                <li><i class="fas fa-cog"></i><span>ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span></li>
            </ul>
        </nav>
    </div>

    <div class="banner-container">
        <div id="bannersCarousel" class="banners">
            <div class="banners-wrapper" id="bannersWrapper">
                </div>
            <button class="banner-nav banner-prev"><i class="fas fa-chevron-right"></i></button>
            <button class="banner-nav banner-next"><i class="fas fa-chevron-left"></i></button>
            <div class="banner-controls" id="bannerControls">
                </div>
        </div>
    </div>

    <div class="rooms-section">
        <div class="rooms-grid" id="roomsContainer">
            <div class="loading-placeholder">ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∫ÿ±ŸÅ...</div>
            </div>
    </div>

    <div id="entryModal" class="modal">
        <div class="modal-content">
            <span class="close" aria-label="ÿ•ÿ∫ŸÑÿßŸÇ">&times;</span>
            <h2 id="entryModalTitle">ÿØÿÆŸàŸÑ ÿßŸÑÿ∫ÿ±ŸÅÿ©</h2>
            <form id="entryForm">
                <div>
                    <label for="username">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</label>
                    <input type="text" id="username" name="username" required placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ŸáŸÜÿß" maxlength="20">
                </div>
                <div class="options-container">
                    <label>ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ™ŸÉ ÿßŸÑÿ±ŸÖÿ≤Ÿäÿ©:</label>
                    <div class="avatar-options">
                        <input type="radio" id="avatar1" name="avatar" value="üë©‚Äçü¶±" checked>
                        <label for="avatar1" class="avatar-label">üë©‚Äçü¶±</label>
                        <input type="radio" id="avatar2" name="avatar" value="üë±‚Äç‚ôÄÔ∏è">
                        <label for="avatar2" class="avatar-label">üë±‚Äç‚ôÄÔ∏è</label>
                        <input type="radio" id="avatar3" name="avatar" value="üë©üèª‚Äçü¶∞">
                        <label for="avatar3" class="avatar-label">üë©üèª‚Äçü¶∞</label>
                        <input type="radio" id="avatar4" name="avatar" value="üë©‚Äçü¶≥">
                        <label for="avatar4" class="avatar-label">üë©‚Äçü¶≥</label>
                    </div>
                </div>
                <div class="options-container">
                    <label>ÿßÿÆÿ™ÿ± ŸÑŸàŸÜ ŸÅŸÇÿßÿπÿ© ÿßŸÑÿØÿ±ÿØÿ¥ÿ©:</label>
                    <div class="color-options">
                        <input type="radio" id="color-blue" name="bubbleColor" value="blue" checked>
                        <label for="color-blue" class="color-label" title="ÿ£ÿ≤ÿ±ŸÇ"></label>
                        <input type="radio" id="color-red" name="bubbleColor" value="red">
                        <label for="color-red" class="color-label" title="ÿ£ÿ≠ŸÖÿ±"></label>
                        <input type="radio" id="color-green" name="bubbleColor" value="green">
                        <label for="color-green" class="color-label" title="ÿ£ÿÆÿ∂ÿ±"></label>
                        <input type="radio" id="color-gold" name="bubbleColor" value="gold">
                        <label for="color-gold" class="color-label" title="ÿ∞Ÿáÿ®Ÿä"></label>
                        <input type="radio" id="color-orange" name="bubbleColor" value="orange">
                        <label for="color-orange" class="color-label" title="ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä"></label>
                        <input type="radio" id="color-default" name="bubbleColor" value="default">
                        <label for="color-default" class="color-label" title="ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä"></label>
                    </div>
                </div>
                <button type="submit" class="entry-button">ÿØÿÆŸàŸÑ ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ÿßŸÑÿ¢ŸÜ</button>
            </form>
        </div>
    </div>

    <div class="chat-page" id="chatPage">
        <div class="chat-header">
            <div class="back-button" id="chatBackButton">
                <i class="fas fa-arrow-right"></i>
            </div>
            <div class="title" id="chatRoomTitle">ÿßÿ≥ŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ©</div>
            <div class="header-spacer"></div>
        </div>
        <div class="chat-content" id="chatContent">
            </div>
        <div class="chat-input-area" id="chatInputArea">
            <div id="replyPreview">
                <span class="cancel-reply" id="cancelReplyBtn" title="ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ±ÿØ">&times;</span>
                <div class="reply-preview-sender">ÿ±ÿØ ÿπŸÑŸâ: <strong id="replyPreviewSender"></strong></div>
                <div class="reply-preview-content" id="replyPreviewContent"></div>
            </div>
            <div class="chat-input-controls">
                <textarea class="chat-input" id="chatInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." rows="1"></textarea>
                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

   <div class="confirmation-dialog" id="deleteConfirmationDialog">
       <div class="confirmation-box">
           <p>ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿü</p>
           <div class="confirmation-buttons">
               <button id="confirmDeleteBtn">ÿ≠ÿ∞ŸÅ</button>
               <button id="cancelDeleteBtn">ÿ•ŸÑÿ∫ÿßÿ°</button>
           </div>
       </div>
   </div>


    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, serverTimestamp, query, orderByChild, limitToLast, remove } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

        // --- Firebase Configuration ---
        // KEEP YOUR CONFIG SECURE - Consider using environment variables or backend functions in production
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your actual API key
            authDomain: "maawaau.firebaseapp.com",
            projectId: "maawaau",
            databaseURL: "https://maawaau-default-rtdb.firebaseio.com",
            storageBucket: "maawaau.appspot.com",
            messagingSenderId: "1098534875401",
            appId: "1:1098534875401:web:c299126a5786c353b2a3d8"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Global Variables ---
        let currentBannerIndex = 0;
        let bannerCount = 0;
        let autoSlideInterval;
        let currentUser = { name: null, avatar: null, color: null, currentRoomId: null };
        let currentMessagesListener = null; // Function to detach listener
        let replyToMessage = null; // Stores { id, sender, text } of message being replied to
        let messageToDeleteId = null; // Stores ID of message pending deletion confirmation
        let longPressTimer = null; // Timer for long press detection
        let swipeStartX = 0;       // Touch start X position for swipe
        let swipeStartY = 0;       // Touch start Y position for swipe
        let swipeCurrentX = 0;     // Touch current X position for swipe
        let isSwiping = false;     // Flag if swipe action is active
        const longPressDuration = 700; // milliseconds for long press
        const swipeThreshold = 50; // pixels to trigger swipe action

        // --- DOM Elements ---
        const navbarLogo = document.getElementById('navbarLogo');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const userIDElement = document.getElementById('userID');
        const idCopyIcon = document.getElementById('idCopyIcon');
        const bannersWrapper = document.getElementById('bannersWrapper');
        const bannerControls = document.getElementById('bannerControls');
        const bannersEl = document.getElementById('bannersCarousel');
        const bannerPrevBtn = document.querySelector('.banner-prev');
        const bannerNextBtn = document.querySelector('.banner-next');
        const roomsContainer = document.getElementById('roomsContainer');
        const entryModal = document.getElementById('entryModal');
        const entryModalCloseBtn = entryModal.querySelector('.close');
        const entryModalTitle = document.getElementById('entryModalTitle');
        const entryForm = document.getElementById('entryForm');
        const usernameInput = document.getElementById('username');
        const chatPage = document.getElementById('chatPage');
        const chatBackButton = document.getElementById('chatBackButton');
        const chatRoomTitle = document.getElementById('chatRoomTitle');
        const chatContent = document.getElementById('chatContent');
        const chatInputArea = document.getElementById('chatInputArea');
        const replyPreview = document.getElementById('replyPreview');
        const replyPreviewSender = document.getElementById('replyPreviewSender');
        const replyPreviewContent = document.getElementById('replyPreviewContent');
        const cancelReplyBtn = document.getElementById('cancelReplyBtn');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const deleteConfirmationDialog = document.getElementById('deleteConfirmationDialog');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        // ========================================================================
        // --- Sidebar Logic ---
        // ========================================================================

        const openSidebar = () => {
            sidebarMenu.classList.add('active');
            sidebarOverlay.classList.add('active');
            // Optional: Prevent body scroll when sidebar is open
            // document.body.style.overflow = 'hidden';
        };

        const closeSidebar = () => {
            sidebarMenu.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            // Optional: Restore body scroll
            // document.body.style.overflow = '';
        };

        const setupSidebarListeners = () => {
            sidebarToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent click from closing immediately if body listener exists
                if (sidebarMenu.classList.contains('active')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });

            sidebarOverlay.addEventListener('click', closeSidebar);

            // Copy ID Functionality
            idCopyIcon.addEventListener('click', () => {
                const userIdText = userIDElement.textContent.replace('ID ', '').trim();
                navigator.clipboard.writeText(userIdText).then(() => {
                    idCopyIcon.classList.replace('fa-copy', 'fa-check');
                    idCopyIcon.classList.add('copied');
                    idCopyIcon.title = "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!";
                    setTimeout(() => {
                        idCopyIcon.classList.replace('fa-check', 'fa-copy');
                        idCopyIcon.classList.remove('copied');
                        idCopyIcon.title = "ŸÜÿ≥ÿÆ ÿßŸÑŸÄ ID";
                    }, 1500);
                }).catch(err => {
                    console.error('Failed to copy ID: ', err);
                    alert('ŸÅÿ¥ŸÑ ŸÜÿ≥ÿÆ ÿßŸÑŸÄ ID.'); // Simple feedback
                });
            });
        };

        // ========================================================================
        // --- Banner Carousel Logic ---
        // ========================================================================

        const loadBanners = () => {
            bannersWrapper.innerHTML = '<div class="banner-slide"><div class="loading-placeholder" style="min-height: 150px; display:flex; align-items:center; justify-content:center;">ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿ±ÿßÿ™...</div></div>'; // Adjusted loading style
            const bannersRef = ref(db, 'banners');

            onValue(bannersRef, (snapshot) => {
                const bannersData = snapshot.val();
                const banners = bannersData ? Object.values(bannersData) : [];
                const validBanners = banners.filter(b => b && b.url && typeof b.url === 'string');

                bannersWrapper.innerHTML = ''; // Clear previous
                bannerControls.innerHTML = ''; // Clear previous
                bannerCount = 0; // Reset

                if (validBanners.length > 0) {
                    validBanners.forEach((banner, index) => {
                        bannerCount++;
                        const slide = document.createElement('div');
                        slide.className = 'banner-slide';
                        const link = (banner.link && typeof banner.link === 'string') ? banner.link : '#';
                        // Added error handling for broken image links
                        slide.innerHTML = `<a href="${link}" target="_blank" rel="noopener noreferrer"><img src="${banner.url}" alt="ÿ®ÿßŸÜÿ± ${index + 1}" loading="lazy" onerror="this.style.display='none'; console.error('Banner Img Load Error: ${banner.url}'); this.closest('a').innerHTML='<p style=\\'color:red; text-align:center; padding:20px;\\'>ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©</p>';"></a>`;
                        bannersWrapper.appendChild(slide);

                        const dot = document.createElement('div');
                        dot.className = 'banner-dot';
                        dot.dataset.index = index;
                        bannerControls.appendChild(dot);
                    });

                    // Ensure everything is setup correctly if banners were added
                     if (bannersWrapper.children.length > 0) {
                         bannerCount = bannersWrapper.children.length; // Update count based on actual slides rendered
                         currentBannerIndex = 0;
                         goToBanner(0, true); // Go to first banner instantly
                         startAutoSlide();
                     } else {
                         showNoBannersMessage(); // Case where filter removed all banners
                     }

                } else {
                    showNoBannersMessage();
                }
            }, (error) => {
                console.error('Error fetching banners:', error);
                showNoBannersMessage('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ÿßŸÜÿ±ÿßÿ™');
                clearInterval(autoSlideInterval);
            });
        };

        const showNoBannersMessage = (message = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿßŸÜÿ±ÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã') => {
            bannersWrapper.innerHTML = `<div class="banner-slide"><p style="text-align: center; padding: 20px; color:${message.includes('ÿÆÿ∑ÿ£') ? 'red' : 'inherit'};">${message}</p></div>`;
            bannerControls.innerHTML = '';
            bannerCount = 0;
            clearInterval(autoSlideInterval);
        };

        const updateBannerDots = (index) => {
            const dots = bannerControls.querySelectorAll('.banner-dot');
            dots.forEach(dot => {
                dot.classList.toggle('active', parseInt(dot.dataset.index) === index);
            });
        };

        const goToBanner = (index, immediate = false) => {
            const actualSlideCount = bannersWrapper.children.length;
            if (actualSlideCount === 0 || index < 0 || index >= actualSlideCount) return;

            currentBannerIndex = index;
            bannersWrapper.style.transition = immediate ? 'none' : 'transform 0.5s ease'; // Disable transition for immediate jump
            bannersWrapper.style.transform = `translateX(-${index * 100}%)`;
            updateBannerDots(index);

             // Restore transition after immediate jump
            if (immediate) {
                 // Use a tiny timeout to ensure the transform is applied before re-enabling transition
                 setTimeout(() => { bannersWrapper.style.transition = 'transform 0.5s ease'; }, 10);
             }

            resetAutoSlide();
        };

        const nextBanner = () => {
            if (bannerCount > 0) {
                const nextIndex = (currentBannerIndex + 1) % bannerCount;
                goToBanner(nextIndex);
            }
        };

        const prevBanner = () => {
            if (bannerCount > 0) {
                const prevIndex = (currentBannerIndex - 1 + bannerCount) % bannerCount;
                goToBanner(prevIndex);
            }
        };

        const startAutoSlide = () => {
            clearInterval(autoSlideInterval);
            if (bannerCount > 1) {
                autoSlideInterval = setInterval(nextBanner, 4500); // Slightly slower interval
            }
        };

        const resetAutoSlide = () => {
            clearInterval(autoSlideInterval);
            startAutoSlide();
        };

        const setupBannerListeners = () => {
             bannerControls.addEventListener('click', (e) => {
                if (e.target.classList.contains('banner-dot')) {
                    goToBanner(parseInt(e.target.dataset.index, 10));
                }
            });
            bannerNextBtn.addEventListener('click', nextBanner);
            bannerPrevBtn.addEventListener('click', prevBanner);

            // Touch swipe listeners
            let touchStartX = 0;
            bannersEl.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                clearInterval(autoSlideInterval); // Pause on touch
            }, { passive: true });

            bannersEl.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchEndX - touchStartX;
                if (diff > swipeThreshold) { // Swipe Right (Previous)
                    prevBanner();
                } else if (diff < -swipeThreshold) { // Swipe Left (Next)
                    nextBanner();
                }
                 // Restart auto-slide only if the swipe didn't trigger navigation (e.g., small movement)
                 // Or always restart after a short delay if preferred
                 // resetAutoSlide(); // Restart immediately after any touch end? Maybe too aggressive.
            }, { passive: true });
        };


        // ========================================================================
        // --- Room Loading Logic ---
        // ========================================================================

        const loadRooms = () => {
            roomsContainer.innerHTML = '<div class="loading-placeholder">ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∫ÿ±ŸÅ...</div>';
            const roomsRef = ref(db, 'products'); // Assuming 'products' is the correct path for rooms

            onValue(roomsRef, (snapshot) => {
                roomsContainer.innerHTML = ''; // Clear previous
                const rooms = snapshot.val() || {};
                const roomIds = Object.keys(rooms);

                if (roomIds.length === 0) {
                    roomsContainer.innerHTML = '<p class="loading-placeholder">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∫ÿ±ŸÅ ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã.</p>';
                    return;
                }

                let roomsAdded = 0;
                roomIds.forEach(roomId => {
                    const roomData = rooms[roomId];
                    // Basic validation
                    if (!roomData || !roomData.title || typeof roomData.title !== 'string' || !roomData.image || typeof roomData.image !== 'string') {
                        console.warn(`Skipping room ${roomId}: Missing/invalid title or image.`);
                        return;
                    }

                    roomsAdded++;
                    const box = document.createElement('div');
                    box.className = 'room-box';
                    box.dataset.roomId = roomId;
                    box.dataset.roomTitle = roomData.title; // Store title for modal

                    // Improved error handling for image
                    box.innerHTML = `
                        <div class="room-image-container">
                            <img src="${roomData.image}" alt="${roomData.title}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\\'color:red;padding:10px; text-align:center;\\'>ÿµŸàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©</p>';">
                        </div>
                        <h3>${roomData.title}</h3>
                    `;

                    box.addEventListener('click', () => {
                        showEntryModal(roomId, roomData.title);
                    });
                    roomsContainer.appendChild(box);
                });

                // Handle case where all rooms were filtered out
                if (roomsAdded === 0 && roomIds.length > 0) {
                    roomsContainer.innerHTML = '<p class="loading-placeholder">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∫ÿ±ŸÅ ÿµÿßŸÑÿ≠ÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿ≠ÿßŸÑŸäÿßŸã.</p>';
                }

            }, (error) => {
                console.error('Error fetching rooms:', error);
                roomsContainer.innerHTML = '<p class="loading-placeholder" style="color: red;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∫ÿ±ŸÅ.</p>';
            });
        };

        // ========================================================================
        // --- Entry Modal Logic ---
        // ========================================================================

        const showEntryModal = (roomId, roomTitle) => {
            entryModalTitle.textContent = `ÿØÿÆŸàŸÑ ÿ∫ÿ±ŸÅÿ©: ${roomTitle}`;
            entryForm.dataset.roomId = roomId; // Store IDs on the form itself
            entryForm.dataset.roomTitle = roomTitle;
            usernameInput.value = localStorage.getItem('lastUsername') || ''; // Pre-fill last used name

            // Reset selections to default each time modal opens
            entryForm.querySelector('input[name="avatar"][value="üë©‚Äçü¶±"]').checked = true;
            entryForm.querySelector('input[name="bubbleColor"][value="blue"]').checked = true;

            entryModal.style.display = 'block';
            entryModal.style.animation = 'fadeIn var(--transition-speed-medium) ease-out';
            entryModal.querySelector('.modal-content').style.animation = 'slideIn var(--transition-speed-slow) ease-out';
             // Use setTimeout to focus after animation starts, improves UX
            setTimeout(() => usernameInput.focus(), 50);
        };

        const hideEntryModal = () => {
            // Add exit animations
            entryModal.style.animation = 'fadeOut var(--transition-speed-medium) ease-out forwards';
            entryModal.querySelector('.modal-content').style.animation = 'slideOut var(--transition-speed-slow) ease-out forwards';

            // Hide after animation completes
            setTimeout(() => {
                entryModal.style.display = 'none';
                // Clear animations to prevent re-playing on next display:block
                entryModal.style.animation = '';
                entryModal.querySelector('.modal-content').style.animation = '';
            }, 450); // Match longest animation duration (slideOut)
        };

        const handleEntrySubmit = (e) => {
            e.preventDefault();
            const name = usernameInput.value.trim();
            const avatar = entryForm.querySelector('input[name="avatar"]:checked').value;
            const color = entryForm.querySelector('input[name="bubbleColor"]:checked').value;
            const roomId = e.target.dataset.roomId;
            const roomTitle = e.target.dataset.roomTitle;

            // Simple validation
            if (!name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ!'); // Replace with better inline validation if desired
                usernameInput.focus();
                return;
            }
            // Removed length check, already have maxlength on input

            if (!roomId || !roomTitle) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠.');
                return;
            }

            currentUser = { name, avatar, color, currentRoomId: roomId };
            localStorage.setItem('lastUsername', name); // Remember username

            hideEntryModal();
            enterChatRoom(roomId, roomTitle);
        };

        const setupEntryModalListeners = () => {
            entryForm.addEventListener('submit', handleEntrySubmit);
            entryModalCloseBtn.addEventListener('click', hideEntryModal);
            entryModal.addEventListener('click', (e) => {
                // Close if clicked outside the modal content
                if (e.target === entryModal) {
                    hideEntryModal();
                }
            });
        };

        // ========================================================================
        // --- Chat Page Logic ---
        // ========================================================================

        const enterChatRoom = (roomId, roomTitle) => {
            chatRoomTitle.textContent = roomTitle;
            chatPage.style.display = 'flex';
            chatPage.style.animation = 'slideInFromBottom var(--transition-speed-slow) ease-out';
            chatContent.innerHTML = ''; // Clear previous messages
            addWelcomeMessage(); // Add the welcome message
            cancelReply(); // Ensure reply state is reset
            chatInput.value = ''; // Clear input field
            adjustTextareaHeight(); // Adjust height for placeholder
            loadMessages(roomId);
            // Focus input after a short delay for smoother transition
            setTimeout(() => chatInput.focus(), 100);
        };

        const leaveChatRoom = () => {
            chatPage.style.animation = 'slideOutToBottom var(--transition-speed-slow) ease-out forwards';

            setTimeout(() => {
                chatPage.style.display = 'none';
                chatPage.style.animation = ''; // Reset animation

                // Detach Firebase listener
                if (currentMessagesListener) {
                    currentMessagesListener(); // Call the detach function returned by onValue
                    currentMessagesListener = null;
                    console.log("Firebase listener detached for room:", currentUser.currentRoomId);
                }

                // Reset user state (keep lastUsername in localStorage)
                currentUser = { name: null, avatar: null, color: null, currentRoomId: null };
                chatContent.innerHTML = ''; // Clear messages
                cancelReply(); // Clear reply state

            }, 450); // Match animation duration
        };

         const addWelcomeMessage = () => {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'welcome-message-container';
            welcomeDiv.innerHTML = `
                <i class="fas fa-lock"></i>
                <p>ÿ£ŸáŸÑÿßŸã ÿ®ŸÉŸÖ ŸÅŸä ŸÖŸÜÿµÿ© Haawa. Ÿäÿ±ÿ¨Ÿâ ÿßÿ≠ÿ™ÿ±ÿßŸÖ ÿ®ÿπÿ∂ŸÜÿß ÿßŸÑÿ®ÿπÿ∂ ŸàÿßŸÑÿ™ÿ≠ÿØÿ´ ÿ®ÿ∑ÿ±ŸäŸÇÿ© ŸÖŸáÿ∞ÿ®ÿ©.</p>
            `;
            chatContent.appendChild(welcomeDiv); // Append instead of prepend maybe? Or check if exists first.
        };

        const setupChatPageListeners = () => {
            chatBackButton.addEventListener('click', leaveChatRoom);
        };

        // ========================================================================
        // --- Message Loading & Display Logic ---
        // ========================================================================

        const loadMessages = (roomId) => {
            const messagesRef = ref(db, `rooms/${roomId}/messages`);
            const messagesQuery = query(messagesRef, orderByChild('timestamp'), limitToLast(60)); // Load slightly more initially

            // Display initial loader
            chatContent.innerHTML = ''; // Clear everything first
            addWelcomeMessage(); // Add welcome message back
            const initialLoader = document.createElement('div');
            initialLoader.className = 'loading-placeholder initial-load';
            initialLoader.textContent = 'ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ...';
            chatContent.appendChild(initialLoader);

            // Detach any previous listener before attaching a new one
            if (currentMessagesListener) {
                currentMessagesListener();
                console.log("Detached previous Firebase listener before attaching new one.");
            }

            // Attach the listener
            currentMessagesListener = onValue(messagesQuery, (snapshot) => {
                const loader = chatContent.querySelector('.loading-placeholder.initial-load');
                if (loader) loader.remove(); // Remove loader once data arrives

                const messagesData = snapshot.val() || {};
                const messageIds = Object.keys(messagesData);

                // Preserve welcome message if needed, or re-add if cleared
                const welcomeMsgElement = chatContent.querySelector('.welcome-message-container');
                chatContent.innerHTML = ''; // Clear previous messages *after* getting data
                if(welcomeMsgElement) chatContent.appendChild(welcomeMsgElement); // Re-add welcome message

                if (messageIds.length === 0) {
                    const noMsgPlaceholder = document.createElement('div');
                    noMsgPlaceholder.className = 'loading-placeholder no-messages';
                    noMsgPlaceholder.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ®ÿπÿØ. ŸÉŸÜ ÿ£ŸàŸÑ ŸÖŸÜ ŸäŸÉÿ™ÿ®!';
                    chatContent.appendChild(noMsgPlaceholder);
                } else {
                    // Sort messages by timestamp client-side for robustness
                    const sortedMessages = messageIds
                        .map(id => ({ id, ...messagesData[id] }))
                        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)); // Handle potential missing timestamps

                    sortedMessages.forEach(message => {
                        // Add message only if it's not already in the DOM
                        // This helps prevent duplicates on minor updates/reloads
                         if (!chatContent.querySelector(`.message-item[data-message-id="${message.id}"]`)) {
                            addMessageToChat(message);
                        }
                    });

                    // Scroll logic: Immediate if near bottom, smooth otherwise
                    const isNearBottom = chatContent.scrollHeight - chatContent.scrollTop <= chatContent.clientHeight + 150; // Increased threshold
                    scrollToBottom(!isNearBottom); // Scroll smoothly unless user scrolled up
                }
            }, (error) => {
                console.error(`Error loading messages for room ${roomId}:`, error);
                const welcomeMsgElement = chatContent.querySelector('.welcome-message-container');
                chatContent.innerHTML = ''; // Clear content on error too
                 if(welcomeMsgElement) chatContent.appendChild(welcomeMsgElement);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'loading-placeholder';
                errorMsg.style.color = 'red';
                errorMsg.textContent = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ.';
                chatContent.appendChild(errorMsg);
                // Detach listener on error
                if (currentMessagesListener) {
                    currentMessagesListener();
                    currentMessagesListener = null;
                }
            });

            console.log("Firebase listener attached for room:", roomId);
        };


        const addMessageToChat = (message) => {
            // Basic validation
            if (!message || !message.sender || !message.text || !message.id || !message.timestamp) {
                console.warn("Skipping incomplete message:", message);
                return;
            }

            // Check if message already exists to prevent duplicates
            if (chatContent.querySelector(`.message-item[data-message-id="${message.id}"]`)) {
                console.log("Skipping duplicate message:", message.id);
                return;
            }


            const isSentByUser = message.sender === currentUser.name;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-item ${isSentByUser ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = message.id;
            messageDiv.dataset.sender = message.sender;
            messageDiv.dataset.text = message.text; // Store original text for actions

            // Avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = message.avatar || 'üë§'; // Use message avatar or fallback

            // Bubble
            const bubbleDiv = document.createElement('div');
            const userColor = isSentByUser ? (message.color || 'default') : 'default'; // Received uses default style
            const bubbleColorClass = isSentByUser ? `bubble-${userColor}` : '';
            bubbleDiv.className = `message-bubble ${bubbleColorClass}`;

            // Reply Context (if present)
            if (message.replyTo && message.replyTo.sender && message.replyTo.text) {
                const replyContextDiv = document.createElement('div');
                replyContextDiv.className = 'reply-context-display';
                // Use sanitized text from replyTo object
                 // Make sure sender/text exists before trying to access
                 const replySender = message.replyTo.sender || "ŸÖÿ≥ÿ™ÿÆÿØŸÖ";
                 const replyText = message.replyTo.text || "...";
                 replyContextDiv.innerHTML = `ÿ±ÿØ ÿπŸÑŸâ <strong>${escapeHtml(replySender)}</strong>: ${escapeHtml(replyText)}`;
                 bubbleDiv.appendChild(replyContextDiv);
            }

            // Sender Name (for received messages)
            if (!isSentByUser) {
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = escapeHtml(message.sender); // Sanitize sender name
                bubbleDiv.appendChild(senderDiv);
            }

            // Message Text
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = message.text; // Assume text is already sanitized before storing/sending
            bubbleDiv.appendChild(textDiv);

            // Time
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = formatTime(message.timestamp);
            bubbleDiv.appendChild(timeDiv);

            // Assemble Element
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);

            // Add interaction listeners (swipe/long-press/contextmenu)
            addMessageInteractionListeners(messageDiv);

            // Append to chat
            chatContent.appendChild(messageDiv);

            // Remove "no messages" placeholder if it exists
            const noMsgPlaceholder = chatContent.querySelector('.loading-placeholder.no-messages');
            if (noMsgPlaceholder) {
                noMsgPlaceholder.remove();
            }
        };

        // ========================================================================
        // --- Message Interaction Logic (Swipe, Long Press, Delete) ---
        // ========================================================================

        const addMessageInteractionListeners = (messageElement) => {
             const messageId = messageElement.dataset.messageId;
             const sender = messageElement.dataset.sender;
             const text = messageElement.dataset.text;
             const isSentMessage = messageElement.classList.contains('sent');

             let touchStartTime = 0; // To differentiate tap from long press/swipe

            // --- Touch Start ---
            messageElement.addEventListener('touchstart', (e) => {
                 // Ignore multi-touch gestures
                 if (e.touches.length > 1) return;

                swipeStartX = e.touches[0].clientX;
                swipeStartY = e.touches[0].clientY;
                swipeCurrentX = swipeStartX; // Initialize
                isSwiping = false; // Reset swipe flag
                touchStartTime = Date.now(); // Record start time

                // Apply faster transition for immediate feedback during interaction
                messageElement.style.transition = 'transform 0.1s ease-out';

                // Clear previous long press timer
                clearTimeout(longPressTimer);

                // Start long press timer *only* for sent messages
                if (isSentMessage) {
                    longPressTimer = setTimeout(() => {
                        isSwiping = true; // Prevent swipe/tap after long press triggers
                        if (navigator.vibrate) navigator.vibrate(50); // Haptic feedback
                        showDeleteConfirmation(messageId);
                         // Reset visual state if user moves finger *after* long press triggered
                         messageElement.style.transform = 'translateX(0)';
                         messageElement.classList.remove('swiping');
                    }, longPressDuration);
                }
             }, { passive: true }); // Passive where possible

             // --- Touch Move ---
             messageElement.addEventListener('touchmove', (e) => {
                 // Ignore multi-touch or if long press already triggered
                 if (e.touches.length > 1 || (longPressTimer && !isSentMessage && Date.now() - touchStartTime > longPressDuration) || (isSentMessage && !longPressTimer) ) return;


                 swipeCurrentX = e.touches[0].clientX;
                 const touchCurrentY = e.touches[0].clientY;
                 const deltaX = swipeCurrentX - swipeStartX;
                 const deltaY = touchCurrentY - swipeStartY;

                 // Prioritize vertical scroll: If vertical move > horizontal move, cancel swipe/long press
                 if (Math.abs(deltaY) > Math.abs(deltaX) + 10) {
                     clearTimeout(longPressTimer);
                     if (isSwiping) { // Reset visual swipe if it started
                         messageElement.style.transform = 'translateX(0)';
                         messageElement.classList.remove('swiping');
                         isSwiping = false;
                     }
                     return; // Exit, allow native scroll
                 }

                 // If significant horizontal movement, cancel long press and activate swipe mode
                 if (Math.abs(deltaX) > 10) {
                     clearTimeout(longPressTimer);
                     if (!isSwiping) {
                         isSwiping = true;
                         messageElement.classList.add('swiping'); // Add class for potential styling
                     }
                 }

                 // Apply visual translation for swipe (only swipe left for reply)
                 if (isSwiping && deltaX < 0) { // Swiping left
                     const translateValue = Math.max(deltaX, -swipeThreshold * 1.8); // Cap visual swipe distance
                     messageElement.style.transform = `translateX(${translateValue}px)`;
                     // Prevent default scroll ONLY when actively swiping horizontally left
                     e.preventDefault();
                 } else if (isSwiping && deltaX >= 0) { // Swiping right (resetting or no action)
                     // Allow moving back right smoothly, but don't go past original position
                     messageElement.style.transform = `translateX(0px)`;
                 }

             }, { passive: false }); // Need false to preventDefault during horizontal swipe

            // --- Touch End ---
            messageElement.addEventListener('touchend', (e) => {
                // Ignore if multi-touch was involved
                if (e.touches.length > 0 || e.changedTouches.length > 1) {
                     // If multi-touch ends, ensure state is reset
                     clearTimeout(longPressTimer);
                     messageElement.style.transform = 'translateX(0)';
                     messageElement.classList.remove('swiping');
                     isSwiping = false;
                     return;
                 }

                clearTimeout(longPressTimer); // Always clear timer

                if (isSwiping) {
                    messageElement.classList.remove('swiping');
                    const deltaX = swipeCurrentX - swipeStartX;

                    // Check if swipe was far enough left to trigger reply
                    if (deltaX < -swipeThreshold) {
                        startReply(messageId, sender, text);
                        if (navigator.vibrate) navigator.vibrate([30, 50, 30]); // Double tap vibration
                    }
                    // Animate back smoothly regardless of action triggered
                    messageElement.style.transition = 'transform 0.25s ease-out'; // Slightly slower, smoother return
                    messageElement.style.transform = 'translateX(0)';

                } else {
                    // If not swiping (tap or short press), ensure position is reset
                    // This might have already been handled, but safe to ensure
                    messageElement.style.transform = 'translateX(0)';
                }

                // Reset state variables
                swipeStartX = 0;
                swipeStartY = 0;
                swipeCurrentX = 0;
                isSwiping = false;
                touchStartTime = 0;

                // Remove inline transition after animation finishes
                 setTimeout(() => {
                    messageElement.style.transition = '';
                }, 250); // Match return animation duration

            });

            // --- Context Menu for Desktop (Delete Sent Messages) ---
            if (isSentMessage) {
                messageElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault(); // Prevent default browser context menu
                    showDeleteConfirmation(messageId);
                });
            }
        };

        const showDeleteConfirmation = (messageId) => {
            messageToDeleteId = messageId;
            deleteConfirmationDialog.style.display = 'flex';
            deleteConfirmationDialog.style.animation = 'fadeIn var(--transition-speed-fast) ease';
            deleteConfirmationDialog.querySelector('.confirmation-box').style.animation = 'slideIn var(--transition-speed-medium) ease-out';
        };

        const hideDeleteConfirmation = () => {
            deleteConfirmationDialog.style.animation = 'fadeOut var(--transition-speed-fast) ease forwards';
            deleteConfirmationDialog.querySelector('.confirmation-box').style.animation = 'slideOut var(--transition-speed-medium) ease-out forwards';
            setTimeout(() => {
                deleteConfirmationDialog.style.display = 'none';
                messageToDeleteId = null;
                // Reset animations
                deleteConfirmationDialog.style.animation = '';
                deleteConfirmationDialog.querySelector('.confirmation-box').style.animation = '';
            }, 300); // Match animation duration
        };

        const handleDeleteConfirm = () => {
            if (!messageToDeleteId || !currentUser.currentRoomId) {
                console.error("Delete Error: Missing message ID or Room ID.");
                hideDeleteConfirmation();
                return;
            }

            const messageRef = ref(db, `rooms/${currentUser.currentRoomId}/messages/${messageToDeleteId}`);
            remove(messageRef)
                .then(() => {
                    console.log("Message deleted:", messageToDeleteId);
                    // UI update happens via the onValue listener detecting the removal
                })
                .catch((error) => {
                    console.error("Error deleting message:", error);
                    alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©.");
                })
                .finally(() => {
                    hideDeleteConfirmation(); // Always close dialog
                });
        };

        const setupDeleteConfirmationListeners = () => {
            confirmDeleteBtn.addEventListener('click', handleDeleteConfirm);
            cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);
             // Close dialog if clicking overlay background
            deleteConfirmationDialog.addEventListener('click', (e) => {
                if (e.target === deleteConfirmationDialog) {
                    hideDeleteConfirmation();
                }
            });
        };

        // ========================================================================
        // --- Message Sending & Reply Logic ---
        // ========================================================================

        const startReply = (messageId, sender, text) => {
            // Create a snippet, max ~50 chars
            const snippet = text.length > 50 ? text.substring(0, 50) + '...' : text;
            replyToMessage = { id: messageId, sender: sender, text: snippet }; // Store snippet

            replyPreviewSender.textContent = escapeHtml(sender); // Display sanitized sender
            replyPreviewContent.textContent = escapeHtml(snippet); // Display sanitized snippet
            replyPreview.style.display = 'block';
            chatInput.focus();
        };

        const cancelReply = () => {
            replyToMessage = null;
            replyPreview.style.display = 'none';
            replyPreviewSender.textContent = '';
            replyPreviewContent.textContent = '';
        };

        const sendMessage = () => {
            const messageText = chatInput.value.trim();
            if (messageText === '' || !currentUser.currentRoomId || !currentUser.name) return;

            // Basic length validation
            if (messageText.length > 1000) {
                alert("ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ∑ŸàŸäŸÑÿ© ÿ¨ÿØÿßŸã (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 1000 ÿ≠ÿ±ŸÅ).");
                return;
            }

            const roomId = currentUser.currentRoomId;
            const messagesRef = ref(db, `rooms/${roomId}/messages`);
            const newMessageRef = push(messagesRef); // Generate unique ID first

            // Prepare message data (basic sanitization)
            const sanitizedText = escapeHtml(messageText); // Sanitize text before sending

            const newMessageData = {
                sender: currentUser.name, // Assume name is safe (set on entry)
                avatar: currentUser.avatar, // Assume safe (emoji)
                color: currentUser.color, // Assume safe (predefined value)
                text: sanitizedText, // Use sanitized text
                timestamp: serverTimestamp(), // Use Firebase server time
                id: newMessageRef.key // Include the message's own ID
            };

            // Add reply context if active
            if (replyToMessage) {
                // Use the already sanitized snippet stored in replyToMessage
                 newMessageData.replyTo = {
                    id: replyToMessage.id,
                    sender: replyToMessage.sender, // Already sanitized when stored
                    text: replyToMessage.text // Already sanitized snippet when stored
                };
            }

            // Send to Firebase
            set(newMessageRef, newMessageData)
                .then(() => {
                    chatInput.value = ''; // Clear input
                    adjustTextareaHeight(); // Reset height
                    cancelReply(); // Clear reply state
                    scrollToBottom(true); // Scroll down immediately after sending
                })
                .catch((error) => {
                    console.error('Error sending message:', error);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©.');
                });
        };

        const setupMessageInputListeners = () => {
            sendButton.addEventListener('click', sendMessage);
            cancelReplyBtn.addEventListener('click', cancelReply);

            chatInput.addEventListener('keydown', (e) => {
                // Send on Enter (not Shift+Enter)
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent newline
                    sendMessage();
                }
                // Cancel reply with Escape key
                if (e.key === 'Escape' && replyToMessage) {
                    cancelReply();
                }
            });

            // Auto-resize textarea
            chatInput.addEventListener('input', adjustTextareaHeight);
        };

        // ========================================================================
        // --- Utility Functions ---
        // ========================================================================

        // Simple HTML escaping function
        const escapeHtml = (unsafe) => {
            if (!unsafe) return ""; // Handle null/undefined input
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Format timestamp to HH:MM AM/PM
        const formatTime = (timestamp) => {
            if (!timestamp || typeof timestamp !== 'number') return '...';
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) return "---"; // Invalid Date check
                return date.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) {
                console.error("Error formatting time:", e, "Timestamp:", timestamp);
                return "---";
            }
        };

        // Adjust textarea height dynamically
        const adjustTextareaHeight = () => {
            chatInput.style.height = 'auto'; // Reset height
            const scrollHeight = chatInput.scrollHeight;
            const maxHeight = 100; // Max height in pixels
            chatInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
            // Optional: Add scrollbar visibility styling if needed when max height is reached
            chatInput.style.overflowY = scrollHeight > maxHeight ? 'scroll' : 'hidden';
        };

        // Scroll chat content to the bottom
        const scrollToBottom = (smooth = true) => {
            const behavior = smooth ? 'smooth' : 'instant';
            // Use a small timeout even for smooth to ensure DOM updates are rendered
            setTimeout(() => {
                chatContent.scrollTo({ top: chatContent.scrollHeight, behavior: behavior });
            }, smooth ? 50 : 0);
        };

        // ========================================================================
        // --- Initialization ---
        // ========================================================================

        const initializeAppUI = () => {
            console.log("Initializing App UI...");
            setupSidebarListeners();
            setupBannerListeners();
            setupEntryModalListeners();
            setupChatPageListeners();
            setupMessageInputListeners();
            setupDeleteConfirmationListeners();

            loadBanners();
            loadRooms();
            adjustTextareaHeight(); // Initial adjustment for placeholder
            console.log("App UI Initialized.");
        };

        // --- Start the application ---
        window.addEventListener('load', initializeAppUI);

    </script>
</body>
</html>
