<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Haawa au - ØºØ±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #000E0F;
      --secondary: #001F23;
      --accent: #00333A;
      --light: #004047;
      --header-light: #001A1F;
      --text: #F5F5F5;
      --bubble-red: #4d0f0f;
      --bubble-red-border: #8b1a1a;
      --bubble-blue: #0f2b4d;
      --bubble-blue-border: #1a4f8b;
      --bubble-green: #104d0f;
      --bubble-green-border: #1e8b1a;
      --bubble-gold: #614a0a;
      --bubble-gold-border: #b48613;
      --bubble-orange: #61350a;
      --bubble-orange-border: #b46013;
      --bubble-default: var(--accent); /* Ù„ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ */
      --bubble-default-border: var(--light);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--primary);
      color: var(--text);
      direction: rtl;
      min-height: 100vh;
      touch-action: manipulation; /* Helps prevent accidental browser gestures */
      overflow-x: hidden; /* Prevent horizontal scroll */
    }
    .navbar {
      background: var(--header-light);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: background-color 0.3s ease; /* Added transition */
    }
    .navbar-brand { display: flex; align-items: center; }
    .navbar img {
      width: 60px; height: 40px; border-radius: 10px;
      margin-left: 10px; object-fit: cover; border: 2px solid var(--light);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); transition: transform 0.3s ease;
    }
    .navbar img:hover { transform: scale(1.05); }
    .navbar .caption { font-size: 16px; color: var(--text); font-weight: 500; }

    /* --- Profile Icon --- */
    .profile-icon-wrapper {
        position: relative;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .profile-icon {
      color: var(--text);
      font-size: 22px;
      cursor: pointer;
      position: relative;
      z-index: 2;
      transition: color 0.3s ease; /* Added transition */
    }
    .profile-icon:hover {
        color: var(--light); /* Slight hover effect */
    }

    .banner-container { max-width: 1024px; margin: 20px auto; padding: 0 15px; overflow: hidden; }
    .banners { position: relative; border-radius: 15px; overflow: hidden; aspect-ratio: 2400/660; max-height: 400px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
    .banners-wrapper { display: flex; transition: transform 0.5s ease; height: 100%; }
    .banner-slide { min-width: 100%; height: 100%; }
    .banners img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .banner-controls { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; z-index: 5; /* Ensure dots are above image */ }
    .banner-dot { width: 12px; height: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease; /* Added transition */ }
    .banner-dot.active { background: #fff; }
    .banner-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.4); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; z-index: 10; transition: background-color 0.3s ease; /* Added transition */ }
    .banner-nav:hover { background: rgba(0, 0, 0, 0.6); }
    .banner-prev { left: 15px; }
    .banner-next { right: 15px; }

    /* --- ØºØ±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
    .rooms-section { padding: 30px 15px; }
    .rooms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .room-box {
      background: var(--secondary);
      border-radius: 15px;
      overflow: hidden;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      aspect-ratio: 1 / 1;
    }
    .room-box:hover {
      transform: translateY(-8px) scale(1.02); /* Slight scale on hover */
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      border-color: var(--light);
    }
    .room-box .room-image-container {
        flex-grow: 1;
        overflow: hidden;
        width: 100%;
        background-color: var(--accent);
    }
    .room-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.4s ease;
    }
    .room-box:hover img { transform: scale(1.05); }
    .room-box h3 {
      font-size: 15px;
      padding: 12px 10px;
      color: var(--text);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: var(--secondary);
      margin: 0;
    }

    /* --- Modal (Entry Form) --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; padding: 20px; overflow-y: auto; animation: fadeIn 0.3s ease-out; }
    .modal-content { background: var(--secondary); margin: 8% auto; padding: 30px; border-radius: 15px; max-width: 450px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); position: relative; animation: slideIn 0.4s ease-out; }
    .modal .close { position: absolute; top: 10px; left: 15px; font-size: 30px; color: #aaa; cursor: pointer; transition: color 0.3s, transform 0.3s ease; line-height: 1; }
    .modal .close:hover { color: #fff; transform: rotate(90deg); }
    .modal h2 { margin-bottom: 25px; color: var(--text); font-size: 20px; text-align: center; }
    .modal label { display: block; margin-bottom: 8px; color: #ddd; font-size: 14px; }
    .modal input[type="text"] {
        width: 100%; padding: 12px; border: 1px solid var(--accent); background: var(--primary); border-radius: 8px; color: var(--text); font-size: 15px; margin-bottom: 15px;
        font-family: 'Tajawal', sans-serif; transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Added transition */
    }
     .modal input[type="text"]:focus { outline: none; border-color: var(--light); box-shadow: 0 0 0 3px rgba(0, 64, 71, 0.5); /* Adjusted focus */ }
    .modal .options-container { margin-bottom: 20px; }
    .modal .avatar-options, .modal .color-options { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 5px; }
    .modal input[type="radio"] { display: none; }
    .modal .avatar-label, .modal .color-label { cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s ease; }
    .modal .avatar-label { font-size: 24px; background-color: var(--accent); line-height: 1; padding: 5px 8px; }
    .modal .color-label { width: 35px; height: 35px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
    .modal input[type="radio"]:checked + label { border-color: #a2d2db; transform: scale(1.15); /* Slightly more scale */ box-shadow: 0 0 10px rgba(162, 210, 219, 0.8); /* Brighter shadow */ }
    /* Specific color styles */
    .modal .color-label[for="color-red"] { background-color: var(--bubble-red); }
    .modal .color-label[for="color-blue"] { background-color: var(--bubble-blue); }
    .modal .color-label[for="color-green"] { background-color: var(--bubble-green); }
    .modal .color-label[for="color-gold"] { background-color: var(--bubble-gold); }
    .modal .color-label[for="color-orange"] { background-color: var(--bubble-orange); }
    .modal .color-label[for="color-default"] { background-color: var(--bubble-default); }

    .modal .entry-button {
      background: linear-gradient(135deg, var(--light), var(--accent));
      border-radius: 12px; padding: 14px; color: #fff; text-decoration: none; font-size: 16px;
      display: block; text-align: center; width: 100%; border: none; cursor: pointer;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */ margin-top: 20px;
    }
    .modal .entry-button:hover { background: linear-gradient(135deg, var(--accent), var(--light)); transform: translateY(-3px) scale(1.01); /* Added scale */ box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3); /* Increased shadow */ }

    /* --- ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
    .chat-page {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--primary); z-index: 1500;
      display: none; flex-direction: column;
      animation: slideInFromBottom 0.4s ease-out; /* Animation for chat page */
    }
    .chat-header {
      background: var(--header-light); padding: 0.8rem 1rem;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: sticky; top: 0; z-index: 10;
    }
    .chat-header .back-button { color: var(--text); font-size: 24px; cursor: pointer; padding: 5px; transition: color 0.3s ease, transform 0.3s ease; /* Added transition */ }
     .chat-header .back-button:hover { color: var(--light); transform: scale(1.1); }
    .chat-header .title { font-size: 17px; font-weight: 500; color: var(--text); text-align: center; flex-grow: 1; margin: 0 15px; }
    .chat-header .header-spacer { width: 34px; }

    .chat-content {
      flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column;
       scroll-behavior: smooth; /* Smooth scrolling */
    }

    /* --- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ --- */
    .welcome-message-container {
        display: flex;
        align-items: center;
        background-color: rgba(0, 31, 35, 0.5);
        padding: 12px 15px;
        border-radius: 10px;
        margin: 0 auto 15px auto;
        max-width: 90%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        animation: fadeIn 0.5s 0.2s ease-out backwards; /* Fade in welcome message */
    }
    .welcome-message-container .fa-lock {
        color: #a2d2db;
        font-size: 16px;
        margin-left: 10px;
    }
    .welcome-message-container p {
        color: #d5d5d5;
        font-size: 14px;
        line-height: 1.5;
        margin: 0;
    }

    /* --- Messages and Reply/Delete --- */
    .message-item {
        max-width: 80%; margin-bottom: 15px; display: flex; align-items: flex-end;
        position: relative; /* Needed for absolute positioning of reply context */
        transition: transform 0.2s ease-out; /* For swipe effect */
        user-select: none; /* Prevent text selection during swipe/long press */
        animation: popIn 0.3s ease-out; /* Message appearance animation */
    }
    .message-item.sent { align-self: flex-end; flex-direction: row-reverse; }
    .message-item.received { align-self: flex-start; }
    .message-item.swiping { transition: none; } /* Disable transition during swipe */

    .message-avatar {
        width: 32px; height: 32px; border-radius: 50%;
        font-size: 18px;
        display: flex; align-items: center; justify-content: center;
        margin: 0 8px;
        background-color: var(--secondary);
        color: var(--text);
        flex-shrink: 0;
        align-self: flex-start;
        margin-top: 5px;
    }
    .message-item.sent .message-avatar { background-color: var(--accent); }

    .message-bubble {
      padding: 10px 14px; border-radius: 18px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); position: relative;
      word-wrap: break-word; max-width: calc(100% - 48px);
      border: 1px solid transparent;
      transition: background-color 0.3s ease; /* Transition for potential interactions */
    }
    /* Bubble Colors */
    .message-item.sent .bubble-red { background-color: var(--bubble-red); border-color: var(--bubble-red-border); border-bottom-right-radius: 4px; }
    .message-item.sent .bubble-blue { background-color: var(--bubble-blue); border-color: var(--bubble-blue-border); border-bottom-right-radius: 4px; }
    .message-item.sent .bubble-green { background-color: var(--bubble-green); border-color: var(--bubble-green-border); border-bottom-right-radius: 4px; }
    .message-item.sent .bubble-gold { background-color: var(--bubble-gold); border-color: var(--bubble-gold-border); border-bottom-right-radius: 4px; }
    .message-item.sent .bubble-orange { background-color: var(--bubble-orange); border-color: var(--bubble-orange-border); border-bottom-right-radius: 4px; }
    .message-item.sent .bubble-default { background-color: var(--bubble-default); border-color: var(--bubble-default-border); border-bottom-right-radius: 4px; }
    .message-item.received .message-bubble { background: var(--secondary); border-bottom-left-radius: 4px; border: 1px solid var(--accent); }

    .message-sender { font-weight: bold; margin-bottom: 4px; color: #a2d2db; font-size: 13px; }
    .message-text { color: #e0e0e0; font-size: 15px; line-height: 1.45; }
    .message-time { font-size: 11px; color: #a0a0a0; margin-top: 5px; text-align: left; }
    .message-item.sent .message-time { text-align: right; }

    /* --- Reply Styling --- */
     .reply-context-display {
        background-color: rgba(0, 0, 0, 0.2);
        padding: 5px 10px;
        margin-bottom: 5px;
        border-radius: 8px;
        border-left: 3px solid var(--light); /* Indicator */
        font-size: 13px;
        color: #c0c0c0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
    .reply-context-display strong { color: #a2d2db; } /* Original sender */

    /* --- Input Area & Reply Preview --- */
    .chat-input-area {
        padding: 12px 15px; background: var(--header-light);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: sticky; bottom: 0; z-index: 10;
        display: flex; flex-direction: column; /* Stack reply preview and input */
    }
    #replyPreview {
        display: none; /* Hidden by default */
        background-color: rgba(0, 64, 71, 0.3); /* --light with alpha */
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        font-size: 13px;
        color: #e0e0e0;
        position: relative;
        animation: slideInFromTop 0.3s ease-out;
    }
    #replyPreview .reply-preview-content {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 3px;
    }
     #replyPreview .reply-preview-sender {
        font-weight: bold;
        color: #a2d2db;
    }
    #replyPreview .cancel-reply {
        position: absolute;
        top: 5px;
        left: 8px; /* Adjusted for LTR close icon */
        font-size: 18px;
        color: #aaa;
        cursor: pointer;
        line-height: 1;
        transition: color 0.2s ease;
    }
     #replyPreview .cancel-reply:hover { color: #fff; }

    .chat-input-controls {
        display: flex; align-items: flex-end; /* Align items to bottom */
    }
    .chat-input {
        flex: 1; background: var(--secondary); border: none; border-radius: 20px;
        padding: 10px 18px; color: var(--text); font-family: 'Tajawal', sans-serif;
        font-size: 15px; resize: none; max-height: 100px; min-height: 20px; /* Changed from 40px */
        line-height: 1.4; overflow-y: auto;
        transition: box-shadow 0.3s ease; /* Added transition */
    }
    .chat-input:focus { outline: none; box-shadow: 0 0 0 2px var(--accent); }

    .send-button {
        background: var(--accent); color: white; border: none; width: 40px; height: 40px;
        border-radius: 50%; margin-right: 10px; display: flex; align-items: center;
        justify-content: center; cursor: pointer; transition: background 0.3s ease, transform 0.2s ease; /* Added transition */
        flex-shrink: 0; position: relative; /* Needed for wave */
    }
    .send-button:hover { background: var(--light); transform: scale(1.1); }
    .send-button:active { transform: scale(0.95); } /* Click effect */
    .send-button i { font-size: 18px; position: relative; z-index: 2; }

    /* --- Sound Wave Effect on Send Button --- */
    .send-button::before,
    .send-button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        border: 2px solid rgba(0, 150, 255, 0.5); /* Blue transparent */
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
        animation: wave 2s infinite ease-out;
        z-index: 1; /* Behind the icon */
        pointer-events: none; /* Allow clicks through */
    }
    .send-button::after {
        animation-delay: 0.5s;
    }
    @keyframes wave {
        0% {
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0.8;
        }
        100% {
            transform: translate(-50%, -50%) scale(2.5);
            opacity: 0;
        }
    }
    /* --- End Sound Wave Effect --- */

    .loading-placeholder { text-align: center; padding: 30px; color: #b8b8b8; font-size: 16px; }

    /* --- Simple Confirmation Dialog (for delete) --- */
    .confirmation-dialog {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7); z-index: 3000;
        justify-content: center; align-items: center; animation: fadeIn 0.2s ease;
    }
    .confirmation-box {
        background: var(--secondary); padding: 25px; border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.4); text-align: center;
        max-width: 300px; animation: slideIn 0.3s ease-out;
    }
    .confirmation-box p { margin-bottom: 20px; color: var(--text); font-size: 16px; }
    .confirmation-buttons button {
        padding: 10px 20px; margin: 0 8px; border: none; border-radius: 6px;
        font-size: 15px; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease;
        font-family: 'Tajawal', sans-serif;
    }
    #confirmDeleteBtn { background-color: #c0392b; color: white; }
    #confirmDeleteBtn:hover { background-color: #e74c3c; transform: translateY(-2px); }
    #cancelDeleteBtn { background-color: var(--accent); color: white; }
    #cancelDeleteBtn:hover { background-color: var(--light); transform: translateY(-2px); }


    /* --- Animations --- */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
     @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
     @keyframes slideInFromTop { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
     @keyframes popIn {
        0% { transform: scale(0.8); opacity: 0; }
        80% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }


    @media (max-width: 768px) {
      .rooms-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; }
      .modal-content { margin: 15% auto; padding: 25px; max-width: 90%; }
      .banners { aspect-ratio: 16/7; max-height: 300px; }
      .message-item { max-width: 90%; }
      .welcome-message-container { max-width: 95%; }
    }
    @media (max-width: 480px) {
      .rooms-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
      .room-box h3 { font-size: 14px; padding: 10px 8px; }
      .navbar { padding: 0.8rem; }
      .navbar img { width: 50px; height: 35px; }
      .banner-nav { width: 30px; height: 30px; font-size: 14px; }
      .chat-header { padding: 0.7rem 0.8rem; }
      .chat-header .title { font-size: 16px; }
      .chat-header .back-button { font-size: 22px; }
      .message-text { font-size: 14px; }
      .message-avatar { width: 28px; height: 28px; font-size: 16px; }
      .modal-content { margin: 20% auto; padding: 20px; } /* Adjusted margin */
      .modal h2 { font-size: 18px; }
      .modal .avatar-label { font-size: 22px; }
      .modal .color-label { width: 30px; height: 30px; }
      .modal .entry-button { font-size: 15px; padding: 12px; }
      .chat-input-area { padding: 10px 12px; }
      .chat-input { padding: 9px 15px; font-size: 14px; }
      .send-button { width: 36px; height: 36px; margin-right: 8px; }
      .send-button i { font-size: 16px; }
      .welcome-message-container p { font-size: 13px; }
      .welcome-message-container .fa-lock { font-size: 14px; }
      #replyPreview { padding: 6px 10px; font-size: 12px; }
      #replyPreview .cancel-reply { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-brand">
      <img id="navbarLogo" src="https://i.postimg.cc/QCtCTctL/IMG.jpg" alt="Ø§Ù„Ø´Ø¹Ø§Ø±">
      <div class="caption">Haawa au</div>
    </div>
    <div class="profile-icon-wrapper">
      <div class="profile-icon" id="userProfileIcon">
        <i class="fas fa-user-circle"></i>
      </div>
    </div>
  </div>

  <div class="banner-container">
    <div id="bannersCarousel" class="banners">
      <div class="banners-wrapper" id="bannersWrapper">
        </div>
      <button class="banner-nav banner-prev"><i class="fas fa-chevron-right"></i></button>
      <button class="banner-nav banner-next"><i class="fas fa-chevron-left"></i></button>
      <div class="banner-controls" id="bannerControls"></div>
    </div>
  </div>

  <div class="rooms-section">
      <div class="rooms-grid" id="roomsContainer">
          <div class="loading-placeholder">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù...</div>
      </div>
  </div>

  <div id="entryModal" class="modal">
    <div class="modal-content">
      <span class="close" aria-label="Ø¥ØºÙ„Ø§Ù‚">&times;</span>
      <h2 id="entryModalTitle">Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©</h2>
      <form id="entryForm">
        <div>
          <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
          <input type="text" id="username" name="username" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
        </div>
        <div class="options-container">
          <label>Ø§Ø®ØªØ± ØµÙˆØ±ØªÙƒ Ø§Ù„Ø±Ù…Ø²ÙŠØ©:</label>
          <div class="avatar-options">
            <input type="radio" id="avatar1" name="avatar" value="ğŸ‘©â€ğŸ¦±" checked>
            <label for="avatar1" class="avatar-label">ğŸ‘©â€ğŸ¦±</label>
            <input type="radio" id="avatar2" name="avatar" value="ğŸ‘±â€â™€ï¸">
            <label for="avatar2" class="avatar-label">ğŸ‘±â€â™€ï¸</label>
            <input type="radio" id="avatar3" name="avatar" value="ğŸ‘©ğŸ»â€ğŸ¦°">
            <label for="avatar3" class="avatar-label">ğŸ‘©ğŸ»â€ğŸ¦°</label>
            <input type="radio" id="avatar4" name="avatar" value="ğŸ‘©â€ğŸ¦³">
            <label for="avatar4" class="avatar-label">ğŸ‘©â€ğŸ¦³</label>
          </div>
        </div>
        <div class="options-container">
          <label>Ø§Ø®ØªØ± Ù„ÙˆÙ† ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:</label>
          <div class="color-options">
            <input type="radio" id="color-blue" name="bubbleColor" value="blue" checked>
            <label for="color-blue" class="color-label" title="Ø£Ø²Ø±Ù‚"></label>
            <input type="radio" id="color-red" name="bubbleColor" value="red">
            <label for="color-red" class="color-label" title="Ø£Ø­Ù…Ø±"></label>
            <input type="radio" id="color-green" name="bubbleColor" value="green">
            <label for="color-green" class="color-label" title="Ø£Ø®Ø¶Ø±"></label>
            <input type="radio" id="color-gold" name="bubbleColor" value="gold">
            <label for="color-gold" class="color-label" title="Ø°Ù‡Ø¨ÙŠ"></label>
            <input type="radio" id="color-orange" name="bubbleColor" value="orange">
            <label for="color-orange" class="color-label" title="Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ"></label>
            <input type="radio" id="color-default" name="bubbleColor" value="default">
            <label for="color-default" class="color-label" title="Ø§ÙØªØ±Ø§Ø¶ÙŠ"></label>
          </div>
        </div>
        <button type="submit" class="entry-button">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¢Ù†</button>
      </form>
    </div>
  </div>

  <div class="chat-page" id="chatPage">
    <div class="chat-header">
      <div class="back-button" id="chatBackButton">
        <i class="fas fa-arrow-right"></i>
      </div>
      <div class="title" id="chatRoomTitle">Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</div>
      <div class="header-spacer"></div> </div>
    <div class="chat-content" id="chatContent">
        </div>
    <div class="chat-input-area" id="chatInputArea">
       <div id="replyPreview">
            <span class="cancel-reply" id="cancelReplyBtn" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯">&times;</span>
            <div class="reply-preview-sender">Ø±Ø¯ Ø¹Ù„Ù‰: <strong id="replyPreviewSender"></strong></div>
            <div class="reply-preview-content" id="replyPreviewContent"></div>
       </div>
       <div class="chat-input-controls">
            <textarea class="chat-input" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="1"></textarea>
            <button class="send-button" id="sendButton">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
  </div>

   <div class="confirmation-dialog" id="deleteConfirmationDialog">
       <div class="confirmation-box">
           <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ</p>
           <div class="confirmation-buttons">
               <button id="confirmDeleteBtn">Ø­Ø°Ù</button>
               <button id="cancelDeleteBtn">Ø¥Ù„ØºØ§Ø¡</button>
           </div>
       </div>
   </div>


  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getDatabase, ref, onValue, push, set, serverTimestamp, query, orderByChild, limitToLast, remove } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js'; // Added remove

    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyA4JLZsImCMDKGuMo_0-2izcqiwyiYBMBo", // KEEP YOUR API KEY SECURE
        authDomain: "maawaau.firebaseapp.com",
        projectId: "maawaau",
        databaseURL: "https://maawaau-default-rtdb.firebaseio.com",
        storageBucket: "maawaau.appspot.com",
        messagingSenderId: "1098534875401",
        appId: "1:1098534875401:web:c299126a5786c353b2a3d8"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Global Variables ---
    let currentBannerIndex = 0;
    let bannerCount = 0;
    let autoSlideInterval;
    let currentUser = { name: null, avatar: null, color: null, currentRoomId: null };
    let currentMessagesListener = null;
    let replyToMessage = null; // Stores { id, sender, text } of message being replied to

    // --- DOM Elements ---
    const bannersWrapper = document.getElementById('bannersWrapper');
    const bannerControls = document.getElementById('bannerControls');
    const roomsContainer = document.getElementById('roomsContainer');
    const entryModal = document.getElementById('entryModal');
    const entryForm = document.getElementById('entryForm');
    const entryModalTitle = document.getElementById('entryModalTitle');
    const usernameInput = document.getElementById('username');
    const chatPage = document.getElementById('chatPage');
    const chatBackButton = document.getElementById('chatBackButton');
    const chatRoomTitle = document.getElementById('chatRoomTitle');
    const chatContent = document.getElementById('chatContent');
    const chatInputArea = document.getElementById('chatInputArea'); // Container for preview + input
    const replyPreview = document.getElementById('replyPreview');
    const replyPreviewSender = document.getElementById('replyPreviewSender');
    const replyPreviewContent = document.getElementById('replyPreviewContent');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const deleteConfirmationDialog = document.getElementById('deleteConfirmationDialog');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const userProfileIcon = document.getElementById('userProfileIcon');


    // --- Banner Functions ---
    const loadBanners = () => {
      bannersWrapper.innerHTML = '<div class="banner-slide"><div class="loading-placeholder" style="min-height: 100px;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø±Ø§Øª...</div></div>';
      onValue(ref(db, 'banners'), (snapshot) => {
        const bannersData = snapshot.val();
        // Handle both object (keys are push IDs) and array structures
        const banners = bannersData ? (Array.isArray(bannersData) ? bannersData : Object.values(bannersData)) : [];
        const validBanners = banners.filter(banner => banner && banner.url); // Ensure banner has a URL
        bannerCount = validBanners.length;

        if (bannerCount > 0) {
          bannersWrapper.innerHTML = '';
          bannerControls.innerHTML = '';
          validBanners.forEach((banner, index) => {
            const slide = document.createElement('div');
            slide.className = 'banner-slide';
            // Ensure link exists, default to '#' if not
            const link = banner.link || '#';
            // **Crucially, check if banner.url exists before creating img**
             if (banner.url) {
                 slide.innerHTML = `<a href="${link}" target="_blank"><img src="${banner.url}" alt="Ø¨Ø§Ù†Ø± ${index + 1}" loading="lazy" onerror="this.style.display='none'; console.error('Failed to load banner image: ${banner.url}');"></a>`; // Added onerror handler
                 bannersWrapper.appendChild(slide);

                 const dot = document.createElement('div');
                 dot.className = 'banner-dot' + (index === 0 ? ' active' : '');
                 dot.dataset.index = index;
                 bannerControls.appendChild(dot);
             } else {
                 console.warn("Banner data missing URL:", banner);
             }
          });
           if (bannersWrapper.children.length > 0) {
              updateBannerDots(0);
              startAutoSlide();
           } else {
              bannersWrapper.innerHTML = '<div class="banner-slide"><p style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù†Ø±Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶.</p></div>';
               bannerControls.innerHTML = '';
           }
        } else {
          bannersWrapper.innerHTML = '<div class="banner-slide"><p style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù†Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>';
          bannerControls.innerHTML = '';
        }
      }, (error) => {
        console.error('Error fetching banners:', error);
        bannersWrapper.innerHTML = '<div class="banner-slide"><p style="text-align: center; padding: 20px; color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª</p></div>';
      });
    };

    const updateBannerDots = (index) => {
      const dots = document.querySelectorAll('.banner-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    };

    const goToBanner = (index) => {
      if (bannerCount === 0 || index < 0 || index >= bannerCount) return; // Check bounds
      currentBannerIndex = index;
      bannersWrapper.style.transform = `translateX(-${index * 100}%)`;
      updateBannerDots(index);
      resetAutoSlide();
    };

    const nextBanner = () => {
      if (bannerCount > 0) {
        goToBanner((currentBannerIndex + 1) % bannerCount);
      }
    };

    const prevBanner = () => {
      if (bannerCount > 0) {
        goToBanner((currentBannerIndex - 1 + bannerCount) % bannerCount);
      }
    };

    const resetAutoSlide = () => {
      clearInterval(autoSlideInterval);
      startAutoSlide();
    };

    const startAutoSlide = () => {
      clearInterval(autoSlideInterval); // Clear existing interval first
      if (bannerCount > 1) {
        autoSlideInterval = setInterval(nextBanner, 4000);
      }
    };

    // --- Room Functions ---
    const loadRooms = () => {
      roomsContainer.innerHTML = '<div class="loading-placeholder">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù...</div>';
      onValue(ref(db, 'products'), (snapshot) => { // Still using 'products'
        roomsContainer.innerHTML = '';
        const rooms = snapshot.val() || {};
        const roomIds = Object.keys(rooms);

        if (roomIds.length === 0) {
          roomsContainer.innerHTML = '<p style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
          return;
        }

        roomIds.forEach(roomId => {
          const roomData = rooms[roomId];
          if (!roomData.title || !roomData.image) {
              console.warn(`Skipping room ${roomId} due to missing title or image.`);
              return;
          }

          const box = document.createElement('div');
          box.className = 'room-box';
          box.dataset.roomId = roomId;
          box.dataset.roomTitle = roomData.title || 'ØºØ±ÙØ© ØºÙŠØ± Ù…Ø³Ù…Ø§Ø©';

          box.innerHTML = `
            <div class="room-image-container">
                <img src="${roomData.image}" alt="${roomData.title}" loading="lazy" onerror="this.parentElement.innerHTML='<p style=\\'color:red;padding:10px;\\'>ØµÙˆØ±Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</p>';">
            </div>
            <h3>${roomData.title}</h3>
          `;

          box.addEventListener('click', () => {
            showEntryModal(roomId, roomData.title);
          });
          roomsContainer.appendChild(box);
        });
      }, (error) => {
        console.error('Error fetching rooms:', error);
        roomsContainer.innerHTML = '<p style="text-align: center; color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>';
      });
    };

    // --- Entry Modal Functions ---
    const showEntryModal = (roomId, roomTitle) => {
      entryModalTitle.textContent = `Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ©: ${roomTitle}`;
      entryForm.dataset.roomId = roomId;
      entryForm.dataset.roomTitle = roomTitle;
      usernameInput.value = localStorage.getItem('lastUsername') || '';
       // Reset selected avatar/color to default maybe?
       entryForm.querySelector('input[name="avatar"][value="ğŸ‘©â€ğŸ¦±"]').checked = true;
       entryForm.querySelector('input[name="bubbleColor"][value="blue"]').checked = true;
      entryModal.style.display = 'block';
      usernameInput.focus();
    };

    const hideEntryModal = () => {
      entryModal.style.animation = 'fadeOut 0.3s ease-out forwards';
      entryModal.querySelector('.modal-content').style.animation = 'slideOut 0.4s ease-out forwards';
      setTimeout(() => {
          entryModal.style.display = 'none';
          entryModal.style.animation = ''; // Reset animation
          entryModal.querySelector('.modal-content').style.animation = '';
      }, 400); // Match animation duration
    };

    entryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = usernameInput.value.trim();
        const avatar = entryForm.querySelector('input[name="avatar"]:checked').value;
        const color = entryForm.querySelector('input[name="bubbleColor"]:checked').value;
        const roomId = e.target.dataset.roomId;
        const roomTitle = e.target.dataset.roomTitle;

        if (!name) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
            usernameInput.focus();
            return;
        }
        if (!roomId) {
            alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØºØ±ÙØ©.');
            return;
        }

        currentUser = { name, avatar, color, currentRoomId: roomId };
        localStorage.setItem('lastUsername', name);

        hideEntryModal();
        enterChatRoom(roomId, roomTitle);
    });

    entryModal.querySelector('.close').addEventListener('click', hideEntryModal);
    window.addEventListener('click', (e) => {
      if (e.target === entryModal) {
        hideEntryModal();
      }
    });

     // --- Profile Icon Action ---
     userProfileIcon.addEventListener('click', () => {
        // Example action: Show user info or settings modal
        if(currentUser.name) {
            alert(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentUser.name}\nØ§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ©: ${currentUser.avatar}\nÙ„ÙˆÙ† Ø§Ù„ÙÙ‚Ø§Ø¹Ø©: ${currentUser.color}`);
        } else {
            alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
            // Optionally, could open the entry modal if a room was last visited
        }
    });

    // --- Chat Room Functions ---
    const enterChatRoom = (roomId, roomTitle) => {
        chatRoomTitle.textContent = roomTitle;
        chatPage.style.display = 'flex';
        chatContent.innerHTML = '';
        addWelcomeMessage();
        cancelReply(); // Ensure reply state is cleared
        chatInput.value = '';
        adjustTextareaHeight();
        loadMessages(roomId);
        setTimeout(() => chatInput.focus(), 100);
    };

    const addWelcomeMessage = () => {
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'welcome-message-container';
        welcomeDiv.innerHTML = `
            <i class="fas fa-lock"></i>
            <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…Ù†ØµØ© Haawa. ÙŠØ±Ø¬Ù‰ Ø§Ø­ØªØ±Ø§Ù… Ø¨Ø¹Ø¶Ù†Ø§ Ø§Ù„Ø¨Ø¹Ø¶ ÙˆØ§Ù„ØªØ­Ø¯Ø« Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù‡Ø°Ø¨Ø©.</p>
        `;
        chatContent.appendChild(welcomeDiv);
    };

    const leaveChatRoom = () => {
        chatPage.style.animation = 'slideOutToBottom 0.4s ease-out forwards';
        setTimeout(() => {
             chatPage.style.display = 'none';
             chatPage.style.animation = ''; // Reset animation
             if (currentMessagesListener) {
                 currentMessagesListener(); // Detach listener
                 currentMessagesListener = null;
             }
             currentUser = { name: null, avatar: null, color: null, currentRoomId: null };
             chatContent.innerHTML = '';
             cancelReply(); // Clear reply state
        }, 400); // Match animation time
    };

    // --- Message Functions ---
    const loadMessages = (roomId) => {
        const messagesRef = ref(db, `rooms/${roomId}/messages`);
        const messagesQuery = query(messagesRef, orderByChild('timestamp'), limitToLast(50));

        const tempLoader = document.createElement('div');
        tempLoader.className = 'loading-placeholder';
        tempLoader.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...';
        if (chatContent.childElementCount <= 1) {
             chatContent.appendChild(tempLoader);
        }

        if (currentMessagesListener) {
            currentMessagesListener(); // Detach previous listener
        }

        currentMessagesListener = onValue(messagesQuery, (snapshot) => {
            const loader = chatContent.querySelector('.loading-placeholder:not(.no-messages)'); // Avoid removing the "no messages" placeholder
            if (loader) loader.remove();

            const messagesData = snapshot.val() || {};
            const messageIds = Object.keys(messagesData);

            const welcomeMsg = chatContent.querySelector('.welcome-message-container');
            chatContent.innerHTML = ''; // Clear existing messages
            if (welcomeMsg) chatContent.appendChild(welcomeMsg);

            if (messageIds.length === 0) {
                 const noMsg = document.createElement('div');
                 noMsg.className = 'loading-placeholder no-messages'; // Add class to distinguish
                 noMsg.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙƒØªØ¨!';
                 chatContent.appendChild(noMsg);
            } else {
                 const sortedMessages = messageIds.map(id => ({ id, ...messagesData[id] }))
                                                .sort((a, b) => a.timestamp - b.timestamp);
                 sortedMessages.forEach(message => {
                     addMessageToChat(message);
                 });
                 scrollToBottom(true); // Scroll immediately on load
             }
        }, (error) => {
            console.error(`Error loading messages for room ${roomId}:`, error);
            chatContent.innerHTML = '';
             addWelcomeMessage();
            const errorMsg = document.createElement('div');
            errorMsg.className = 'loading-placeholder';
            errorMsg.style.color = 'red';
            errorMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.';
            chatContent.appendChild(errorMsg);
        });
    };

    // --- Add Message with Reply/Swipe/LongPress Logic ---
    const addMessageToChat = (message) => {
        if (!message || !message.sender || !message.text || !message.id) return; // Need ID now

        const isSent = message.sender === currentUser.name;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-item ${isSent ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = message.id; // Store message ID
        messageDiv.dataset.sender = message.sender; // Store sender
        messageDiv.dataset.text = message.text; // Store text for reply/delete context

        // Avatar
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = message.avatar || (isSent ? currentUser.avatar : 'ğŸ‘¤');

        // Bubble
        const bubbleDiv = document.createElement('div');
        const bubbleColorClass = isSent ? `bubble-${message.color || currentUser.color || 'default'}` : '';
        bubbleDiv.className = `message-bubble ${bubbleColorClass}`;

        // Display Reply Context if exists
        if (message.replyTo) {
            const replyContextDiv = document.createElement('div');
            replyContextDiv.className = 'reply-context-display';
             // Fetch original message snippet if needed (complex) or just show sender/placeholder
             replyContextDiv.innerHTML = `Ø±Ø¯ Ø¹Ù„Ù‰ <strong>${message.replyTo.sender || 'Ø±Ø³Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©'}</strong>: ${message.replyTo.text ? message.replyTo.text.substring(0, 30) + '...' : '...'}`;
            bubbleDiv.appendChild(replyContextDiv);
        }

        // Sender Name (for received)
        if (!isSent) {
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = message.sender;
            bubbleDiv.appendChild(senderDiv);
        }

        // Message Text
        const textDiv = document.createElement('div');
        textDiv.className = 'message-text';
        textDiv.textContent = message.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        bubbleDiv.appendChild(textDiv);

        // Time
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = formatTime(message.timestamp);
        bubbleDiv.appendChild(timeDiv);

        // Assemble
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(bubbleDiv);
        chatContent.appendChild(messageDiv);

        // --- Add Interaction Listeners ---
        addMessageInteractionListeners(messageDiv);

        // Remove "no messages" placeholder
        const noMsgPlaceholder = chatContent.querySelector('.loading-placeholder.no-messages');
        if (noMsgPlaceholder) {
            noMsgPlaceholder.remove();
        }
    };

    // --- Message Interaction Handlers ---
    const addMessageInteractionListeners = (messageElement) => {
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let isSwiping = false;
        let longPressTimer = null;
        const longPressDuration = 700; // milliseconds for long press
        const swipeThreshold = 50; // pixels to trigger swipe

        const messageId = messageElement.dataset.messageId;
        const sender = messageElement.dataset.sender;
        const text = messageElement.dataset.text;
        const isSentMessage = messageElement.classList.contains('sent');

        // --- Touch Start ---
        messageElement.addEventListener('touchstart', (e) => {
            // Don't prevent default for vertical scrolling
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isSwiping = false;
            messageElement.style.transition = 'transform 0.1s ease-out'; // Faster transition for interaction

            // Start long press timer only for sent messages
            if (isSentMessage) {
                clearTimeout(longPressTimer); // Clear any previous timer
                longPressTimer = setTimeout(() => {
                    // Long press detected
                    showDeleteConfirmation(messageId);
                    // Vibrate feedback (optional, requires browser support)
                    if (navigator.vibrate) navigator.vibrate(50);
                    // Prevent swipe/click after long press detected
                    isSwiping = true; // Use isSwiping to block other actions
                }, longPressDuration);
            }
        }, { passive: true }); // Allow default scroll

        // --- Touch Move ---
        messageElement.addEventListener('touchmove', (e) => {
            touchEndX = e.touches[0].clientX;
            const touchEndY = e.touches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

             // If moving vertically more than horizontally, likely scrolling, cancel actions
            if (Math.abs(deltaY) > Math.abs(deltaX) + 10) {
                 clearTimeout(longPressTimer); // Cancel long press if scrolling vertically
                 if (isSwiping) { // Reset position if swipe was initiated
                     messageElement.style.transform = 'translateX(0)';
                     messageElement.classList.remove('swiping');
                     isSwiping = false;
                 }
                 return; // Do nothing more if it's a scroll
             }


            // Clear long press timer if finger moves significantly
            if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                clearTimeout(longPressTimer);
            }

             // --- Swipe Left Logic (for Reply) ---
             // Only allow swipe left (negative deltaX) for reply
             if (deltaX < -10) { // Start swiping left
                 isSwiping = true;
                 messageElement.classList.add('swiping');
                 // Move element visually, capped at a certain distance
                 const translateValue = Math.max(deltaX, -swipeThreshold * 1.5); // Cap the visual swipe
                 messageElement.style.transform = `translateX(${translateValue}px)`;
             } else if (deltaX > 0 && isSwiping) { // Moving back to right while swiping
                const translateValue = Math.max(deltaX - swipeThreshold * 1.5, -swipeThreshold * 1.5);
                messageElement.style.transform = `translateX(${translateValue}px)`;
             } else {
                 // Reset if swiping right or not enough movement
                 messageElement.style.transform = 'translateX(0)';
             }


        }, { passive: false }); // Need false to potentially prevent default on horizontal swipe? Test this.

        // --- Touch End ---
        messageElement.addEventListener('touchend', (e) => {
            clearTimeout(longPressTimer); // Always clear timer on touchend

            const deltaX = touchEndX - touchStartX;

             if (isSwiping) {
                 messageElement.classList.remove('swiping');
                  // Check if swipe was enough to trigger reply (swipe left)
                  if (deltaX < -swipeThreshold) {
                      // --- Trigger Reply Action ---
                      startReply(messageId, sender, text);
                      // Vibrate feedback (optional)
                      if (navigator.vibrate) navigator.vibrate(30);
                      // Animate back smoothly after short delay
                      setTimeout(() => { messageElement.style.transform = 'translateX(0)'; }, 50);
                  } else {
                      // Not enough swipe, animate back
                      messageElement.style.transform = 'translateX(0)';
                  }
             } else {
                 // If not swiping (i.e., likely a tap or very short drag), ensure position is reset
                 messageElement.style.transform = 'translateX(0)';
             }

            // Reset state
            touchStartX = 0;
            touchEndX = 0;
            touchStartY = 0;
            isSwiping = false;
            // Ensure transition is reset for normal operations
             setTimeout(() => { messageElement.style.transition = ''; }, 100);

        });
    };

    // --- Reply Handling ---
    const startReply = (messageId, sender, text) => {
        replyToMessage = { id: messageId, sender: sender, text: text };
        replyPreviewSender.textContent = sender;
        replyPreviewContent.textContent = text.substring(0, 50) + (text.length > 50 ? '...' : ''); // Show snippet
        replyPreview.style.display = 'block';
        chatInput.focus();
    };

    const cancelReply = () => {
        replyToMessage = null;
        replyPreview.style.display = 'none';
        replyPreviewSender.textContent = '';
        replyPreviewContent.textContent = '';
    };

    cancelReplyBtn.addEventListener('click', cancelReply);

    // --- Delete Handling ---
    let messageToDeleteId = null;

    const showDeleteConfirmation = (messageId) => {
        messageToDeleteId = messageId;
        deleteConfirmationDialog.style.display = 'flex';
    };

    const hideDeleteConfirmation = () => {
        messageToDeleteId = null;
        deleteConfirmationDialog.style.display = 'none';
    };

    confirmDeleteBtn
